<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Low Power Assistant Middleware Library 5.8.0: Low Power Assistant Middleware Library 5.8.0</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="infineon_logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Low Power Assistant Middleware Library 5.8.0</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Low Power Assistant Middleware Library 5.8.0 </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="section_lpa_overview"></a>
Overview</h1>
<p >Power consumption is a key operational factor for embedded devices. The Low Power Assistant (LPA) allows you to configure a MCU and WLAN (Wi-Fi / Bluetooth&reg; radio) device to provide low-power features. This framework presents a unified, low-overhead, user-friendly way to configure, connect, and operate within multiple tasks/cases.</p>
<p >The key points for LPA include:</p>
<ul>
<li>Applies to MCU, Wi-Fi, and Bluetooth&reg;</li>
<li>For RTOS-oriented applications (FreeRTOS/ThreadX).</li>
<li>Configuration of LPA middleware is required. Application code changes are needed to call LPA middleware functions in runtime.</li>
<li>Configurations are done using ModusToolbox&trade; Device Configurator flow.</li>
</ul>
<h2><a class="anchor" id="section_lpa_features"></a>
Features</h2>
<p >There are various use cases for the LPA covered in the following sections. The LPA allows you to configure different parts of the design to be energy-efficient.</p>
<ul>
<li><a class="el" href="index.html#group_lpa_p1">Part 1. MCU Low Power</a> Allows you to configure MCU to enter low-power mode to achieve maximum power savings.</li>
<li><a class="el" href="index.html#group_lpa_p2">Part 2. Wi-Fi low power</a><ul>
<li><a class="el" href="index.html#group_lpa_p2_host_wake">Wi-Fi host-wake signal</a> Allows the WLAN device to wake up the Host MCU from its low-power state.</li>
<li><a class="el" href="index.html#group_lpa_p2_arp_offload">Wi-Fi ARP Offload</a> Improves the power consumption of the connected system by reducing the time that the host needs to stay awake because of ARP broadcast traffic.</li>
<li><a class="el" href="index.html#group_lpa_p2_packet_filter">Wi-Fi Packet filter offload</a> Allows the host processor to limit which types of packets get passed up to the host processor from the WLAN subsystem. This is useful to keep out unwanted/unneeded packets from the network that might otherwise wake up the host out of a power saving Deep Sleep mode, or prevent it from entering Deep Sleep mode.</li>
<li><a class="el" href="index.html#group_lpa_p2_tcp_keepalive">Wi-Fi TCP keepalive offload</a> Improves the power consumption of the host MCU by offloading TCP keepalive to WLAN firmware.</li>
<li><a class="el" href="index.html#group_lpa_p2_dltro">DHCP Lease Time Renew offload</a> Improves the power consumption of the host MCU by offloading periodic sending of DHCP Request to DHCP server on lease time expiry to WLAN firmware.</li>
<li><a class="el" href="index.html#group_lpa_p2_icmp">ICMP offload</a> Improves the power consumption of the host MCU by offloading ping reply to ping request from peer to WLAN firmware.</li>
<li><a class="el" href="index.html#group_lpa_p2_ndoe">Neighbor Discovery offload</a> Improves the power consumption of the host MCU by offloading Neighbor Advertisement response to Neighbor Solicitation request from peer to WLAN firmware.</li>
<li><a class="el" href="index.html#group_lpa_p2_null_keepalive">NULL Keepalive offload</a> Improves the power consumption of the host MCU by offloading periodic sending of NULL keepalive packets to WLAN firmware.</li>
<li><a class="el" href="index.html#group_lpa_p2_nat_keepalive">NAT Keepalive offload</a> Improves the power consumption of the host MCU by offloading periodic sending of NAT keepalive packets to WLAN firmware.</li>
<li><a class="el" href="index.html#group_lpa_p2_wowlpf">Wake on WirelessLAN</a> Allows the MCU to wake on configured patterns. This is useful to keep out from waking up the host from low power for unwanted packets.</li>
<li><a class="el" href="index.html#group_lpa_p2_mqtt_keepalive">MQTT keepalive offload</a> Improves the power consumption of the host MCU by offloading MQTT keepalive functionality to WLAN firmware.</li>
</ul>
</li>
<li><a class="el" href="index.html#group_lpa_p3">Part 3. Bluetooth&reg; Low Power</a> Enable the Bluetooth&reg; wake-up pins by configuring the Bluetooth&reg; host wake pin and Bluetooth&reg; device wake pin.</li>
</ul>
<p >The listed capabilities make the LPA middleware useful for a variety of applications, including automotive, IoT, and industrial.</p>
<p >The LPA middleware provides an easy way to make the low-power features of Infineon devices available to developers in the form of a portable configuration layer. LPA consists of the following components:</p><ul>
<li>One of these components is a configurator tool (using a personality), which makes the low-power features of the system easy to use (<a href="https://www.infineon.com/ModusToolboxDeviceConfig"><b>ModusToolbox&trade; Device Configurator Tool Guide</b></a>). This personality writes data structures that are processed by the firmware and implement the choices made in the personality.</li>
<li>This firmware is another component of the LPA feature. The firmware is used at system initialization and does not require user interaction.</li>
<li>A small firmware module provides integration between the low-power firmware and the user application. This final piece of firmware will be part of the end-user application.</li>
</ul>
<h1><a class="anchor" id="section_lpa_getting_started"></a>
Getting started</h1>
<p >The LPA middleware can be used in various software environments. The quickest way to get started is by using the Code Examples. Infineon continuously extends its portfolio of code examples at the <a href="http://www.infineon.com"><b>Infineon website</b></a> and at the <a href="https://github.com/Infineon"><b>Infineon GitHub</b></a> website. The following quick start guide sections describe several use cases for using the LPA features:</p><ul>
<li>MCU low power <a class="el" href="index.html#group_lpa_p1_mcu_qsg">Quick start guide</a></li>
<li>Wi-Fi host wake signal <a class="el" href="index.html#group_lpa_p2_host_wake_qsg">Quick start guide</a></li>
<li>Address Resolution Protocol (ARP) Offload <a class="el" href="index.html#group_lpa_p2_arp_offload_qsg">Quick start guide</a></li>
<li>Packet filter offload <a class="el" href="index.html#group_lpa_p2_packet_filter_qsg">Quick start guide</a></li>
<li>TCP keepalive offload <a class="el" href="index.html#group_lpa_p2_tcp_keepalive_qsg">Quick start guide</a></li>
<li>DHCP Lease Time Renew offload offload <a class="el" href="index.html#group_lpa_p2_dltro_qsg">Quick start guide</a></li>
<li>ICMP offload <a class="el" href="index.html#group_lpa_p2_icmp_qsg">Quick start guide</a></li>
<li>Neighbor Discard offload <a class="el" href="index.html#group_lpa_p2_ndoe_qsg">Quick start guide</a></li>
<li>NULL keepalive offload <a class="el" href="index.html#group_lpa_p2_null_keepalive_qsg">Quick start guide</a></li>
<li>NAT keepalive offload <a class="el" href="index.html#group_lpa_p2_nat_keepalive_qsg">Quick start guide</a></li>
<li>Wake on WirelessLAN <a class="el" href="index.html#group_lpa_p2_wowlpf_qsg">Quick start guide</a></li>
<li>MQTT keepalive offload <a class="el" href="index.html#group_lpa_p2_mqtt_keepalive_qsg">Quick start guide</a></li>
<li>Bluetooth&reg; low power</li>
</ul>
<p >For more details about LPA and ModusToolbox&trade;, refer to the <a class="el" href="index.html#section_lpa_more_information">More information</a> section.</p>
<h1><a class="anchor" id="section_lpa_Prerequisites"></a>
Prerequisites</h1>
<ul>
<li>Availability of any of the supported kits.<br  />
</li>
<li>ModusToolbox&trade; development environment. <dl class="section note"><dt>Note</dt><dd>The CY8CKIT-062S2-43012 Kit is recommended because this section documents the measurement instructions for this kit. If another kit is used, refer to its documentation and learn how to measure the current consumed.</dd></dl>
</li>
</ul>
<h1><a class="anchor" id="group_lpa_definitions"></a>
Definitions</h1>
<p >This section lists the definitions used in this document.</p>
<table class="doxtable">
<tr>
<th>Acronym/Term</th><th>Definition</th><th>Remark </th></tr>
<tr>
<td>AP </td><td>Access Point </td><td>Wireless AP connection for the device (e.g., Wireless router). </td></tr>
<tr>
<td>ARP </td><td>Address Resolution Protocol </td><td>ARP is a procedure for mapping a dynamic IP address to a permanent physical machine address in a local area network (LAN). </td></tr>
<tr>
<td>TKO </td><td>TCP keepalive offload </td><td></td></tr>
<tr>
<td>BT </td><td>Bluetooth&trade; </td><td>Bluetooth is a wireless technology standard. </td></tr>
<tr>
<td>Device </td><td>WLAN device </td><td>The Wi-Fi and/or Bluetooth&reg; radio module (WLAN processor) </td></tr>
<tr>
<td>Host </td><td>Host processor </td><td>The host (or application) processor (e.g., PSoC&trade; 6 / CM33 in CYW955913EVK-01). </td></tr>
<tr>
<td>LPA </td><td>Low Power Assistant </td><td></td></tr>
<tr>
<td>OLM </td><td>Offload Manager </td><td></td></tr>
<tr>
<td>OOB </td><td>Out-Of-Band </td><td></td></tr>
<tr>
<td>Configurator </td><td>Infineon configuration tool </td><td>Configurators are a set of powerful but intuitive tools that work together to set up various MCU features. Each Configurator generates very readable, user-modifiable firmware to initialize the whole device with a single function call. Refer to <a href="https://www.infineon.com/products/modustoolbox-software-environment"><b>ModusToolBox&trade;</b></a> </td></tr>
<tr>
<td>Personality </td><td>Information file </td><td>Personalities are files that define how resources are used by a configurator. The Low Power Assistant functionality is embedded in the Device Configurator as a personality. </td></tr>
<tr>
<td>SDIO </td><td>Secure Digital Input/Output </td><td></td></tr>
<tr>
<td>WLAN </td><td>Wireless Local Area Network </td><td>Any WLAN, including Wi-Fi, which is a type of WLAN and adheres to the IEEE 802.11 standards, can be wireless. </td></tr>
<tr>
<td>MTB </td><td>ModusToolbox&trade; </td><td>Refer to <a href="https://www.infineon.com/products/modustoolbox-software-environment"><b>ModusToolBox&trade;</b></a> </td></tr>
<tr>
<td>DHCP </td><td>Dynamic Host Configuration Protocol </td><td>DHCP is a client/server network protocol that is used to configure network devices to communicate on an IP network. </td></tr>
<tr>
<td>DLTRO </td><td>DHCP Lease Time Renew Offload </td><td></td></tr>
<tr>
<td>ICMP </td><td>Internet Control Message Protocol </td><td>ICMP is a network layer protocol used by network devices to diagnose network communication issues. </td></tr>
<tr>
<td>NAT </td><td>Network Address Translation </td><td>NAT is the process of mapping an internet protocol (IP) address to another by changing the header of IP packets while in transit via a router. </td></tr>
<tr>
<td>MQTT </td><td>Message Queuing Telemetry Transpor </td><td>MQTT is a lightweight, publish-subscribe machine to machine network protocol for message queue/message queuing service </td></tr>
</table>
<h1><a class="anchor" id="group_device_configurator_flow"></a>
ModusToolbox™ Device Configurator flow</h1>
<p >Generating the initialization code using the ModusToolbox&trade; Device Configurator greatly simplifies configuring the device and enabling the LPA features. The ModusToolbox&trade; Device Configurator provides the user interface to set up and automatically generate the initialization code (including analog routing) and configuration structures.</p>
<p ><b>Note</b> If you modify the output of the ModusToolbox&trade; Device Configurator, you cannot import it back into the tool.</p>
<p ><b>PSoC&trade; 6 </b></p>
<ul>
<li>Open ModusToolbox&trade; Device Configurator by executing the command "make device-configurator" or by right clicking on the application in the project workspace. Select ModusToolbox&trade; -&gt; Device Configurator. For more details refer to <a href="https://www.infineon.com/dgdl/Infineon-infineon-device-configurator-user-guide-UserManual-v13_00-EN.pdf?fileId=8ac78c8c92416ca5019277a000152389&amp;redirId=180683">Infineon Device Configurator user guide</a></li>
<li>Select the host device tab, and then select the System tab for that device.</li>
<li>Enable the Power personality (if disabled) and go to the Power Parameters pane to configure the LPA Middleware.</li>
<li>Configure RTOS related parameters:<ol type="1">
<li>System Idle Power Mode (Active/Sleep/DeepSleep)</li>
<li>Deep Sleep Latency</li>
</ol>
</li>
<li>Select File-&gt;Save to generate the initialization code.</li>
</ul>
<div class="image">
<img src="Power_Personality.png" alt=""/>
</div>
<p >After saving the configuration file, the generated code is available under the GeneratedSource folder, located in the same directory as the design.modus file in the BSP:</p><ul>
<li>C Data File: GeneratedSource/cycfg_platform.c</li>
<li>C Header File: GeneratedSource/cycfg_platform.h</li>
</ul>
<p ><b>Note</b> Using the ModusToolbox&trade; Device Configurator overwrites changes that you made in the cycfg_system.h file.</p>
<p ><b>CYW955913EVK-01</b></p>
<p >For CYW955913EVK-01 Idle Power Mode can be configured to Active or Deepsleep using the Device Configurator. Follow the below mentioned steps to do that.</p>
<p ><b>Note</b> By default the system is configured to deep sleep power mode.</p>
<ul>
<li>Navigate to the ModusToolbox&trade; installation folder and launch the ModusToolbox&trade; Device Configurator (&lt;install_dir&gt;/tools_3.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it: <br  />
 <em>&lt;code_example&gt;/bsps/TARGET_CYW955913EVK-01/config/design.modus</em> <br  />
</li>
<li>Select the <b>Power</b> tab and tick the <b>MCU</b> check box in Resource.</li>
<li>Go to the MCU - Parameters pane and tick the <b>Enable MCU Low Power</b> check box under Power.</li>
<li>Update <b>Idle Power Mode config</b> by selecting Active/Deepsleep in the dropdown.</li>
<li>Select File-&gt;Save to generate the initialization code.</li>
</ul>
<div class="image">
<img src="Power_Personality_CYW955913EVK.png" alt=""/>
</div>
<p >After saving the configuration file, the generated code is available under the GeneratedSource folder, located in the same directory as the design.modus file in the BSP:</p><ul>
<li>C Data File: GeneratedSource/cycfg_peripherals.c</li>
<li>C Header File: GeneratedSource/cycfg_peripherals.h</li>
</ul>
<h1><a class="anchor" id="group_lpa_p1"></a>
Part 1. MCU Low Power</h1>
<p >The MCU low-power feature allows you to take advantage of the power saving features of a PSoC&trade; MCU simply by configuring a few parameters. Using the MCU low-power feature, you can configure the system to achieve maximum power savings during system idling or to establish maximum performance by operating only in Active power mode. This feature works in conjunction with FreeRTOS.</p>
<p >There are two parameters available: System Idle Power Mode and Deep Sleep Latency.</p>
<p >The System Idle Power Mode parameter defines the power state that the MCU needs to enter automatically any time the system is idle. Setting it to Active power mode disables power saving and allows the system to perform tasks with less intervention because there are no transitions to/from CPU Sleep/System Deep Sleep states.</p>
<p >The Deep Sleep Latency parameter controls the time the system should remain in IDLE state before entering into sleep state.</p>
<p >For more information, refer the SysPm (System Power Management) from the <a href="https://www.infineon.com/assets/row/public/documents/30/68/infineon-modustoolbox-tools-package-user-guide-gettingstarted-en.pdf"><b>PDL section of ModusToolbox&trade; tools package user guide</b></a>.</p>
<p >The LPA library provides features for MCU Low Power, Wi-Fi Low Power and Bluetooth&reg; Low Power; however, the LPA library only needs to be included in applications that use Wi-Fi low power.</p>
<h2><a class="anchor" id="group_lpa_p1_mcu_qsg"></a>
Quick start guide</h2>
<p ><b>PSoC&trade; 6 </b></p>
<p >This quick start guide demonstrates how to configure and use the WLAN_HOST_WAKE pin for the MCU Low Power feature in the FreeRTOS environment. This guide also shows the feature's impact on the system's low power.</p>
<ol type="1">
<li>Create existing Code Example <a href="https://github.com/Infineon/mtb-example-psoc6-empty-app.git"><b>mtb-example-psoc6-empty-app</b></a> available in the ModusToolbox&trade; environment for <a href="https://www.infineon.com/dgdl/Infineon-CY8CKIT-062S2-43012_PSoC_62S2_Wi-Fi_BT_Pioneer_Kit_Guide-UserManual-v01_00-EN.pdf?fileId=8ac78c8c7d0d8da4017d0f01c8f11927"><b>CY8CKIT-062S2-43012</b></a> device.</li>
<li>Add FreeRTOS library into the application using Library Manager. Follow below steps for adding library.<ul>
<li>Right click on the application in the project workspace. Select ModusToolbox&trade; -&gt; Library Manager.</li>
<li>Click on "Add Library".</li>
<li>Search "freertos" library and select update.</li>
</ul>
</li>
<li>Copy the latest <a href="https://github.com/Infineon/freertos/tree/master/Source/portable"><b> FreeRTOSConfig.h</b></a> to the application root directory.</li>
<li>Set the desired System Idle Power mode (DeepSleep, Sleep or Active). In FreeRTOS, the System Idle Power mode is set to Deep Sleep by default to achieve the best power saving. This step can be done by using the ModusToolbox&trade; Device Configurator <b>MCU Low power using the ModusToolbox&trade; Device Configurator</b> Refer to <a class="el" href="index.html#group_device_configurator_flow">ModusToolbox&trade; Device Configurator flow</a></li>
<li>Upate main.c file with the following code. FreeRTOS-based application is needed for the system to enter low-power during system idling. LED ON/OFF state is used to measure the power when system is in active and sleep state. <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cy_pdl.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cyhal.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cybsp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;task.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define BLINKING_RATE_MS        5000</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> blinky(<span class="keywordtype">void</span> *args)</div>
<div class="line">{</div>
<div class="line">    TickType_t ticks = pdMS_TO_TICKS(BLINKING_RATE_MS) ;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the User LED</span></div>
<div class="line">    cyhal_gpio_init((cyhal_gpio_t) CYBSP_USER_LED, CYHAL_GPIO_DIR_OUTPUT, CYHAL_GPIO_DRIVE_STRONG, CYBSP_LED_STATE_OFF);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">while</span> (<span class="keyword">true</span>)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">//Turn ON LED</span></div>
<div class="line">        cyhal_gpio_write((cyhal_gpio_t)CYBSP_USER_LED, <span class="keyword">false</span>);</div>
<div class="line">        <span class="comment">//Add Delay for 5 seconds so that MCU does not go to Deep Sleep</span></div>
<div class="line">        cyhal_system_delay_ms(BLINKING_RATE_MS);</div>
<div class="line">        <span class="comment">//Turn OFF LED</span></div>
<div class="line">        cyhal_gpio_write((cyhal_gpio_t)CYBSP_USER_LED, <span class="keyword">true</span>);</div>
<div class="line">        vTaskDelay(ticks) ;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"><span class="keywordtype">int</span> main(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    cy_rslt_t result;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Initialize the device and board peripherals</span></div>
<div class="line">    result = cybsp_init() ;</div>
<div class="line">    <span class="keywordflow">if</span> (result != CY_RSLT_SUCCESS)</div>
<div class="line">    {</div>
<div class="line">        CY_ASSERT(0);</div>
<div class="line">    }</div>
<div class="line">    __enable_irq();</div>
<div class="line"> </div>
<div class="line">    xTaskCreate( blinky, <span class="stringliteral">&quot;Blinky Task&quot;</span>, 1024*10,  0,  1,  0);</div>
<div class="line">    <span class="comment">// Start the FreeRTOS scheduler</span></div>
<div class="line">    vTaskStartScheduler();</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Execute the following commands to build and program the application. Below is an example for the CY8CKIT_062S2_43012 Board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>Check the board operation. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to measure power consumption</a> section for corresponding instructions. Observe the power consumption in different states of the main thread (Active and Idle). The illuminated user LED indicates the Active state. The non-illuminated LED indicates the Idle state. The duration of Active/Idle states can be adjusted by changing the BLINKING_RATE_MS value in the blinky function. Refer to the following picture for an example of the DC Power Analyzer output:</li>
</ol>
<div class="image">
<img src="FreeRTOS_blinky_current.png" alt="" height="500px"/>
</div>
<p ><b>CYW955913EVK-01</b></p>
<ol type="1">
<li>Create existing Code Example <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power"><b>mtb-example-threadx-cyw5591x-low-power</b></a> available in the ModusToolbox&trade; environment for <b>CYW955913EVK-01</b> device.</li>
<li>MCU low power is enabled by default in CYW955913EVK-01.</li>
<li>Execute the following commands to build and program the application. <div class="fragment"><div class="line">make getlibs</div>
<div class="line">make build TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application starts, the console output shows a list of options. The application is initially holding sleep lock to allow the user to enter their option.</li>
<li>Press '7' to allow system sleep. The application will release the sleep lock and allow the system to enter Deep Sleep.</li>
<li>Since the Wi-Fi is not active and MCU is idle, the system enters Deep Sleep. Refer to <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power/blob/master/README.md"><b>README.md</b></a> of mtb-example-threadx-cyw5591x-low-power application for instructions to measure power.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p1_cc"></a>
MCU Low Power Configuration Considerations</h2>
<p >Refer to the section <a class="el" href="index.html#group_device_configurator_flow">ModusToolbox&trade; Device Configurator flow</a> to configure MCU low power using design.modus</p>
<h3><a class="anchor" id="group_lpa_p1_cc_parameters"></a>
Configuration Parameters</h3>
<p ><b>PSoC&trade; 6 </b></p>
<p >The following parameters and their mapping to macros are available:</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Parameter </th><th>Description </th><th>Parameter values </th></tr>
<tr>
<td>RTOS </td><td>System Idle Power Mode </td><td>Selects the lowest power mode the system attempts to enter when there are no active tasks to execute; that is, the system is in idle state. This option only applies to an RTOS based application. </td><td><ul>
<li>System Deep Sleep (default)</li>
<li>CPU Sleep</li>
<li>Active </li>
</ul>
</td></tr>
<tr>
<td>RTOS </td><td>Deep Sleep Latency (ms) </td><td>Selects the greater value among time required to enter in and exit from the Deep Sleep power mode. This option only applies to an RTOS based application. </td><td><ul>
<li>0 (default)</li>
<li>0-1000 </li>
</ul>
</td></tr>
</table>
<p ><b>CYW955913EVK-01</b></p>
<p >Following are the idle power mode configuration parameters:</p>
<table class="doxtable">
<tr>
<th>Parameter </th><th>Description </th><th>Recommended Configuration </th></tr>
<tr>
<td>Idle power mode config </td><td>Selects the power mode that the core operates in when idle – Active or Deep Sleep. </td><td><ul>
<li>Deep Sleep (for maximum power saving)</li>
<li>Active (for minimum latency) </li>
</ul>
</td></tr>
<tr>
<td>Power/SysPM Callback Ignore mode </td><td>Allows selecting the callback states for which the application does not want to get a callback for. </td><td>Tick the check-box “check fail” to ignore sleep check failed messages for an unsuccessful sleep attempt. </td></tr>
</table>
<h1><a class="anchor" id="group_lpa_p2"></a>
Part 2. Wi-Fi low power</h1>
<p >Low Power Assistant provides features for MCU low power, Wi-Fi low power, and Bluetooth&reg; low power. LPA library only needs to be included in applications that use Wi-Fi low power.</p>
<p >The WLAN FW supports various offloads that continue operations on behalf of the host while the host is asleep. Making the best use of these FW offloads requires proper configuration, as well as coordination with the host OS and host power management systems. Until now, each application developer was responsible for discovering the existence of FW offloads, learning how to use and configure them, and coordinating with the host's power management system. The offloads manager (OLM) is responsible for:</p><ul>
<li>Encapsulating the configuration, coordination, and knowledge of WLAN offloads into a single, portable, easy-to-use middleware.</li>
<li>Providing a consistent means of developing offloads.</li>
<li>Providing a platform agnostic configuration and initialization interface.</li>
</ul>
<p >Integrating WLAN offloads on the host has typically been performed by customers or hard-coded into the WLAN driver. With the introduction of an offload configurator, customers can configure a range of offloads. This configuration is consistent and portable since multiple platforms perform similar steps to integrate any particular offload.</p>
<p >Power consumption is a key operational factor for embedded devices. WLAN offloads play a key role in determining the host power consumption because offloads let the host go into System Deep Sleep mode for extended periods of time while handling things like 802.11 roaming, ARP, IPV6 neighbor resolution, key rotation, and TCP keep alive, on behalf of the host.</p>
<p >However, each one of these different offloads needs to be recognized, configured, connected to the power management subsystem, and debugged. Currently, this needs to be done by each individual application developer. Because of the high overhead, offloads are often overlooked, and therefore power consumption is not as low as it could be.</p>
<p >The LPA middleware provides a framework that manages WLAN offloads, reduces the overhead incurred by application developers, and makes the offloads more usable while reducing host power consumption.</p>
<p >The framework:</p><ul>
<li>Encapsulates the programming for all low-power offloads it supports. Application writers do not need to know these details.</li>
<li>Uses the ModusToolbox&trade; Device Configurator and personalities to configure:<ul>
<li>which offloads will get compiled in</li>
<li>Parameters for each offload</li>
</ul>
</li>
<li>Each offload has its own set of configured parameters and its own implementation. Offloads do not call functionality contained in another offload.</li>
<li>Provides a consistent means of developing offloads.</li>
<li>Is adaptable to new offloads being offered by the firmware.</li>
<li>Is easily portable new hosts and new architectures. Therefore, the OLM is independent on the platform and network stack.</li>
<li>Code efficient:<ul>
<li>Minimal space: The object code for an offload driver that is never used at run-time is not linked into the program image.</li>
<li>Static memory usage: no runtime calls to malloc/free.</li>
</ul>
</li>
<li>The framework supports multiple WLAN host driver instances. That is, a collection of offload driver instances and configurations are applied per WLAN host driver instance.</li>
</ul>
<p >Each offload can be enabled or disabled at build-time.</p>
<h2><a class="anchor" id="group_lpa_p2_host_wake"></a>
Wi-Fi host-wake signal</h2>
<p >Host-wake provides a way for a WLAN device to wake up the host MCU from its low-power state. Host-wake is implemented using a GPIO on the MCU that is connected to the WLAN device. The WLAN device asserts the host-wake GPIO to bring the host MCU out of its low-power state. This interrupt is called as an out-of-band (OOB) interrupt. This configuration is critical for all the WLAN Low power offload such as ARP, Packet Filter, TCP keepalive to wake up host MCU out of its low-power state.</p>
<p >Refer to the <a class="el" href="index.html#group_lpa_p2_cc">Wi-Fi low power configuration considerations</a> section to configure the Host-wake pin on the Host. The Host-wake pin polarity is configurable. The WLAN device is configured to re-route the SDIO in-band card interrupt to WL_HOST_WAKE (OOB GPIO interrupt). The following diagram shows connections between the host and WLAN device:</p>
<div class="image">
<img src="HostWakeSignal.png" alt="" height="150px"/>
</div>
<p >Where:</p><ul>
<li>SDIO: clock, data</li>
<li>WL_HOST_WAKE: OOB interrupt line to wake Host for service</li>
</ul>
<h3><a class="anchor" id="group_lpa_p2_host_wake_qsg"></a>
Quick start guide</h3>
<p ><b>PSoC&trade; 6 </b></p>
<p >This quick start guide demonstrates how to configure and use the WLAN_HOST_WAKE pin for the MCU low power feature in the FreeRTOS environment. This guide also shows the feature's impact on the system's low power.</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Refer section <a class="el" href="index.html#group_lpa_p2_cc_hostwake">Wi-Fi host wake configuration</a> to verify WLAN_HOST_WAKE pin configurations using device configurator.</li>
<li><p class="startli">Execute the following command to build and program the application. Below is an example for the CY8CKIT_062S2_43012 Board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --><p class="startli">When the application starts, the console output shows that it connects to the specified Wi-Fi Access Point, and then the PSoC&trade; 6 MCU goes to System Deep Sleep mode. </p><div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li><p class="startli">PSoC&trade; 6 MCU is in System Deep Sleep mode. Only WLAN OOB can wake up the host in this situation. Check the board operation. Use a PC to connect to the same Wi-Fi AP as the PSoC&trade; 6 board.</p>
<p class="startli">Send a "ping" command to the board and observe in the serial terminal that the PSoC&trade; 6 MCU wakes up each command: </p><div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div>
<div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=274ms TTL=255</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=393ms TTL=255</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=396ms TTL=255</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div>
<div class="line">    Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div>
<div class="line">Approximate round trip times in milli-seconds:</div>
<div class="line">    Minimum = 274ms, Maximum = 396ms, Average = 354ms</div>
<div class="line"> </div>
<div class="line">&lt;Terminal logs &gt;</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 443ms</div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:91, rx_total:97, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2314, cmd53_read:488, cmd53_write:607</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:93, sdio_intrs:187, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU will enter Deep sleep power mode.</div>
</div><!-- fragment --><p> Ping traffic causes WLAN OOB wakes up the host, and oob_intrs displayed in the serial terminal output shows the number of WLAN OOB interrupts received.</p>
</li>
</ol>
<p ><b>NOTE :</b> For CY8CEVAL-062S2-CYW43022CUB device, ICMP ping is offloaded to WLAN firmware and ping traffic does not wake-up the host. To verify the OOB interrupts, send TCP/UDP packets which cause the host to wake-up.</p>
<p ><b>CYW955913EVK-01</b></p>
<ol type="1">
<li>Create existing Code Example <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power"><b>mtb-example-threadx-cyw5591x-low-power</b></a> available in the ModusToolbox&trade; environment for <b>CYW955913EVK-01</b> device.</li>
<li>MCU low power is enabled by default in CYW955913EVK-01.</li>
<li>Modify the <b>WIFI_SSID</b> and <b>WIFI_PASSWORD</b> in <em>wifi_functions.h</em> to the desired Access Point.</li>
<li>Execute the following command to build and program the application. <div class="fragment"><div class="line">make build TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application starts, the console output shows a list of options. Press '2' to connect to the pre-defined Access Point.</li>
<li>Once the device connects to AP, press '7' to release the sleep lock which allows the system to enter deep sleep. <div class="fragment"><div class="line">************************************************************************</div>
<div class="line">                   Low Power Application Start</div>
<div class="line"> ************************************************************************</div>
<div class="line">********************* Available Commands *******************************</div>
<div class="line">**1) Press <span class="charliteral">&#39;1&#39;</span> to initialize WLAN  *************************************</div>
<div class="line">**2) Press <span class="charliteral">&#39;2&#39;</span> to connect to a predefined AP ***************************</div>
<div class="line">**3) Press <span class="charliteral">&#39;3&#39;</span> to start iperf session **********************************</div>
<div class="line">**4) Press <span class="charliteral">&#39;4&#39;</span> to initialize Bluetooth *********************************</div>
<div class="line">**5) Press <span class="charliteral">&#39;5&#39;</span> to start Bluetooth LE advertisements ********************</div>
<div class="line">**6) Press <span class="charliteral">&#39;6&#39;</span> to lock sleep *******************************************</div>
<div class="line">**7) Press <span class="charliteral">&#39;7&#39;</span> to allow sleep ******************************************</div>
<div class="line">**8) Press <span class="charliteral">&#39;8&#39;</span> to disconnect from the AP *******************************</div>
<div class="line">**9) Press <span class="charliteral">&#39;9&#39;</span> any time in application to start scan *******************</div>
<div class="line">*10) Press <span class="charliteral">&#39;t&#39;</span> to initiate a connection to pre-configured TCP server****</div>
<div class="line">*11) Press <span class="charliteral">&#39;h&#39;</span> any time in application to print the menu****************</div>
<div class="line">************************************************************************</div>
<div class="line">Setting up wake source</div>
<div class="line">Received character 2</div>
<div class="line"> </div>
<div class="line">[1040] WLAN MAC Address : 00:A0:50:73:E9:C6</div>
<div class="line"> </div>
<div class="line">[1040] WLAN Firmware    : wl0: Apr 30 2024 06:00:23 version 28.10.212 (b71ca01) FWID 01-f5464446</div>
<div class="line"> </div>
<div class="line">[1040] WLAN CLM         : API: 20.0 Data: IFX.BRANCH_18_53 Compiler: 1.49.5 ClmImport: 1.48.0 Customization: v3 24/04/08 Creation: 2024-04-29 22:07:56</div>
<div class="line"> </div>
<div class="line">[1040] WHD VERSION      : 300.3.0.23648</div>
<div class="line">[1040]  : EAP v300.3.0</div>
<div class="line">[1050]  : GCC 11.3</div>
<div class="line">[1050]  : 2024-05-03 09:19:44 +0000</div>
<div class="line">Wi-Fi Connection Manager initialized.</div>
<div class="line">Connecting to Wi-Fi Network: ACTFIBERNET</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 0 #######</span></div>
<div class="line">Connecting to AP ...</div>
<div class="line">######### Received <span class="keyword">event</span> changed from wcm, <span class="keyword">event</span> = 1 #######</div>
<div class="line">Connected to AP and network is up !!</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 5 #######</span></div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Successfully connected to Wi-Fi network <span class="stringliteral">&#39;ACTFIBERNET&#39;</span>.</div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Connected AP details Channel: 6, Channel width: 20, Signal strength(dBm): -13</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Received character 7</div>
<div class="line">Sleep unlocked</div>
</div><!-- fragment --></li>
<li><p class="startli">Use a PC to connect to the same Wi-Fi AP as the device under test.</p>
<p class="startli">Send a "ping" command to the board and observe in the serial. Device wakes-up for the ping packets. </p><div class="fragment"><div class="line">&lt;Terminal logs when device wakes-up&gt;</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 24750ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line"> </div>
<div class="line">[42530] WHD Stats..</div>
<div class="line">tx_total:11, rx_total:0, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line"> </div>
<div class="line">[42540] Bus stats not available</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_arp_offload"></a>
Wi-Fi ARP Offload</h2>
<p >The ARP Offload part of the LPA is designed to improve the power consumption of your connected system by reducing the time the Host needs to stay awake due to ARP broadcast traffic. In general, the ARP Offload reduces the broadcast traffic. To enable this support, refer to the <a class="el" href="index.html#group_lpa_p2_cc">Wi-Fi low power configuration considerations</a> section. This document describes how to enable the ARP Offload features that can be incorporated into your project from <a href="https://github.com/Infineon/lpa"><b>Infineon GitHub LPA Middleware</b></a>.</p>
<p >ARP is used for mapping an IP address (e.g., 192.168.1.1)) to a physical machine address (e.g., ac:32:df:14:16:07) lookup. ARP uses broadcast frames to accomplish this.</p><ul>
<li>Reduce the System Deep Sleep wake-up to reduce the host processor power consumption.</li>
<li>Reduce network traffic. If many IoT devices are in one space, the Wi-Fi bands can get congested with unnecessary broadcast traffic.</li>
</ul>
<p >ARP broadcast traffic is normally forwarded from the network to the device (Wi-Fi radio) and then to the host (application CPU) network stack. If the host is sleeping, the device wakes it up. Having the device handle some of the ARP traffic will reduce the frequency that the host sleeps/wakes up, reducing the host power consumption by staying in CPU Sleep and System Deep Sleep states longer. Having the device handle some of the ARP requests from the host to the network will reduce network traffic.</p>
<div class="image">
<img src="ARP1.png" alt="" height="500px"/>
</div>
<p >The WLAN ARP Offload feature of the LPA helps you configure the ARP requests handled by the device.</p>
<h3><a class="anchor" id="group_lpa_p2_awake_sleeping"></a>
Awake vs. Sleeping</h3>
<p >The ARP offload feature of the LPA has the following basic modes:</p><ul>
<li>While the host (host processor) is "Awake"</li>
<li>While the host (host processor) is in CPU Sleep or System Deep Sleep mode.</li>
</ul>
<p >It is possible to enable and configure these modes based on the Sleep status of the application CPU.</p>
<h3><a class="anchor" id="group_lpa_p2_hostautoreply"></a>
Host Auto Reply</h3>
<p >Host Auto Reply is a power-saving and network traffic reduction feature. Using the ARP Offload Host Auto Reply feature, the device answers host ARP requests, without broadcasting to the network. If a host generated ARP request results in a cache hit in the device ARP cache, the device fabricates an ARP response and not forward the request to the network.</p>
<p >This may be useful when the host ARP cache is cleared to disable the host ARP table entry timers before entering the System Deep Sleep mode. When the host is woken up, if the host ARP cache queries in its own network stack and results in a cache miss, the host ARP request will be sent to the device. If the ARP request results in a cache hit in the device, the device responds without soliciting the network. As long as the device ARP cache entry is not expired, the device fabricates an ARP response to the host, which therefore reduces the broadcast traffic.</p>
<p >The ARP agent is enabled by setting the ARP Offload Agent flag and ARP Offload Enable in the Device Configurator. The ARP agent stores the "ARP IP : MAC" combos in the device ARP cache. The device ARP cache is filled with IP:MAC combos when ARP offload and ARP agent are enabled and the network has responded to a host ARP request. There is an "age out" value that you can set in the ARP offload configuration to determine the length of time the ARP cache entry is valid. This ensures that the WLAN ARP cache is updated appropriately.</p>
<p >The size of the WLAN device ARP cache is 16. The host network stack maintains an ARP cache regardless if the WLAN device ARP agent is turned ON or not.</p>
<div class="image">
<img src="ARP2.png" alt="" height="550px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_peerautoreply"></a>
Peer Auto Reply</h3>
<p >Peer Auto Reply is a power-saving feature that allows the Wi-Fi device to reply to ARP request from the network peers without waking the host. This can be enabled by enabling the 'ARP Offload Enable' and 'Peer Auto Reply' flags in the Device Configurator. Once the system connects to the network, the host instructs the Wi-Fi device to reply to ARP requests on its behalf while the host is in low-power state.</p>
<p >The maximum number of entries for this feature is set to 8 (defined in the device firmware and cannot be modified).</p>
<div class="image">
<img src="ARP3.png" alt="" height="600px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_hostpeerautoreply"></a>
Host and Peer Auto Reply</h3>
<p ><a class="el" href="index.html#group_lpa_p2_hostautoreply">Host Auto Reply</a> and <a class="el" href="index.html#group_lpa_p2_peerautoreply">Peer Auto Reply</a> features can be enabled together for the application CPU Awake mode.</p>
<h3><a class="anchor" id="group_lpa_p2_hostsnoop"></a>
Host IP Snoop</h3>
<p >When enabled, the Snoop facility watches for ARP responses from the host to the network, and caches them in the WLAN device host IP table. The size of this table is 8 entries, which allows for the device to support multiple IP addresses.</p>
<h3><a class="anchor" id="group_lpa_p2_arp_offload_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the ARP offload feature and its impact on system power consumption.</p>
<p ><b>PSoC&trade; 6</b></p>
<p >Follow the below steps for application creation.</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Configure the ARP offload. The easiest way to configure ARP offload is to use the ModusToolbox&trade; Device Configurator. <br  />
<ul>
<li><u>Configuring ARP offload on CY8CEVAL-062S2-CYW43022CUB, CYW955913EVK-01, CY8CEVAL-062S2-CYW955513SDM2WLIPA and KIT_PSE84_EVAL_EPC2</u> <br  />
<ul>
<li>ARP offload is enabled by default in the WLAN firmware with configuration set to <a class="el" href="index.html#group_lpa_p2_hostpeerautoreply">Host and Peer Auto Reply</a>. Hence user is not required to do any configuration settings in ModusToolbox&trade; Device Configurator. <dl class="section note"><dt>Note</dt><dd>ARP Ageout time set by the firmware is 20 minutes.</dd></dl>
</li>
</ul>
</li>
<li><u>Configuring ARP offload on all other kits:</u> <br  />
<ul>
<li>Refer section <a class="el" href="index.html#group_lpa_p2_cc_hostwake">Wi-Fi host wake configuration</a> to verify WLAN_HOST_WAKE pin configurations using the Device Configurator.</li>
<li>In design.modus, switch to the connectivity device "CYW943012WKWBG" tab (if the CY8CKIT_062S2_43012 Board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable ARP offload.</li>
<li>Set "ARP offload Feature(s)" to "Peer Auto Reply".</li>
<li>Enable "Snoop Host IP From Traffic When ARP Offload Enabled".</li>
<li>Set "ARP Offload Cache Entries Expire after (s)" to 1200.</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Execute following command to build and program the application. below is example for the CY8CKIT_062S2_43012 Board , using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application starts, the console output shows that it connects to the specified Wi-Fi AP, and then the PSoC&trade; 6 MCU goes to System Deep Sleep mode. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi AP as the PSoC&trade; 6 board.<ul>
<li>Send a "ping" command to the board and observe in the serial terminal that the PSoC&trade; 6 MCU wakes up for each command: <div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div>
<div class="line"> </div>
<div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=319ms TTL=255</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=233ms TTL=255</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=151ms TTL=255</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div>
<div class="line">  Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div>
<div class="line">Approximate round trip times in milli-seconds:</div>
<div class="line">  Minimum = 151ms, Maximum = 319ms, Average = 234ms</div>
<div class="line"> </div>
<div class="line">&lt;Terminal logs &gt;</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC&trade; 6 MCU is in Deep Sleep mode. </p><div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 10.0.0.201</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 113.078ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 1115.498ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 1113.863ms</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201/arp</div>
<div class="line">   3 probes sent.</div>
<div class="line">   3 successful, 0 failed.</div>
<div class="line">Approximate trip times in milli-seconds:</div>
<div class="line">   Minimum = 113.078ms, Maximum = 1115.498ms, Average = 780.813ms</div>
</div><!-- fragment --><p class="startli">Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address]</li>
</ul>
<p class="startli">Because the WLAN device’s ARP cache is empty on the initial ARP request from the peer, it looks up the IP details from the host and updates its ARP cache. This causes the host to wake up because of network activity between the host MCU and the WLAN device. On subsequent ARP requests from the peer, the host remains asleep. The WLAN device continues to respond to the ARP request as it has the ARP data available in its ARP cache.</p>
</li>
</ul>
</li>
<li>Verify the ARP offload is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to measure power consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the ARP offload enabled: <div class="image">
<img src="FreeRTOS_ARP_Enable.png" alt="" height="500px"/>
</div>
 While the WLAN device (purple graph) high spikes responds to each request, the PSoC&trade; 6 host (blue graph) is in System Deep Sleep mode.</li>
<li>Disable the ARP Offload feature and observe that the PSoC&trade; 6 host wakes up on each request. Launch the ModusToolbox&trade; Device Configurator and open the appropriate design.modus file. Select the "CYW943012WKWBG" tab, select Power-&gt;Wi-Fi personality, and disable ARP offload by deselecting the check box next to "ARP offload". Save the configuration. Then, build and program the application. With ARP offload disabled, the host MCU (PSoC&trade; 6) wakes up for every ARP request. <b>NOTE:</b> For CY8CEVAL-062S2-CYW43022CUB ARP offload cannot be disabled.</li>
</ol>
<div class="image">
<img src="FreeRTOS_ARP_Disable.png" alt="" height="500px"/>
</div>
<p ><b>CYW955913EVK-01</b></p>
<p >Follow the below steps for application creation.</p>
<ol type="1">
<li>Create existing Code Example <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power"><b>mtb-example-threadx-cyw5591x-low-power</b></a> available in the ModusToolbox&trade; environment for <b>CYW955913EVK-01</b> device.</li>
<li>MCU low power is enabled by default in CYW955913EVK-01.</li>
<li>Modify the <b>WIFI_SSID</b> and <b>WIFI_PASSWORD</b> in <em>wifi_functions.h</em> to the desired Access Point.</li>
<li>Configure the ARP offload. The easiest way to configure ARP offload is to use the ModusToolbox&trade; Device Configurator. <br  />
<ul>
<li><u>Configuring ARP offload on CYW955913EVK-01:</u> <br  />
<ul>
<li>ARP offload is enabled by default in the WLAN firmware with configuration set to <a class="el" href="index.html#group_lpa_p2_hostpeerautoreply">Host and Peer Auto Reply</a>. Hence user is not required to do any configuration settings in ModusToolbox&trade; Device Configurator.</li>
</ul>
</li>
</ul>
</li>
<li>Execute following command to build and program the application: <div class="fragment"><div class="line">make build TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li><p class="startli">When the application starts, the console output shows a list of options. Press '2' to connect to the pre-defined Access Point.</p>
<dl class="section note"><dt>Note</dt><dd>As part of Wi-Fi connection, the offload gets initialized.</dd></dl>
</li>
<li>Once the device connects to AP, press '7' to release the sleep lock which allows the system to enter deep sleep. <div class="fragment"><div class="line">************************************************************************</div>
<div class="line">                   Low Power Application Start</div>
<div class="line"> ************************************************************************</div>
<div class="line">********************* Available Commands *******************************</div>
<div class="line">**1) Press <span class="charliteral">&#39;1&#39;</span> to initialize WLAN  *************************************</div>
<div class="line">**2) Press <span class="charliteral">&#39;2&#39;</span> to connect to a predefined AP ***************************</div>
<div class="line">**3) Press <span class="charliteral">&#39;3&#39;</span> to start iperf session **********************************</div>
<div class="line">**4) Press <span class="charliteral">&#39;4&#39;</span> to initialize Bluetooth *********************************</div>
<div class="line">**5) Press <span class="charliteral">&#39;5&#39;</span> to start Bluetooth LE advertisements ********************</div>
<div class="line">**6) Press <span class="charliteral">&#39;6&#39;</span> to lock sleep *******************************************</div>
<div class="line">**7) Press <span class="charliteral">&#39;7&#39;</span> to allow sleep ******************************************</div>
<div class="line">**8) Press <span class="charliteral">&#39;8&#39;</span> to disconnect from the AP *******************************</div>
<div class="line">**9) Press <span class="charliteral">&#39;9&#39;</span> any time in application to start scan *******************</div>
<div class="line">*10) Press <span class="charliteral">&#39;t&#39;</span> to initiate a connection to pre-configured TCP server****</div>
<div class="line">*11) Press <span class="charliteral">&#39;h&#39;</span> any time in application to print the menu****************</div>
<div class="line">************************************************************************</div>
<div class="line">Setting up wake source</div>
<div class="line">Received character 2</div>
<div class="line"> </div>
<div class="line">[1040] WLAN MAC Address : 00:A0:50:73:E9:C6</div>
<div class="line"> </div>
<div class="line">[1040] WLAN Firmware    : wl0: Apr 30 2024 06:00:23 version 28.10.212 (b71ca01) FWID 01-f5464446</div>
<div class="line"> </div>
<div class="line">[1040] WLAN CLM         : API: 20.0 Data: IFX.BRANCH_18_53 Compiler: 1.49.5 ClmImport: 1.48.0 Customization: v3 24/04/08 Creation: 2024-04-29 22:07:56</div>
<div class="line"> </div>
<div class="line">[1040] WHD VERSION      : 300.3.0.23648</div>
<div class="line">[1040]  : EAP v300.3.0</div>
<div class="line">[1050]  : GCC 11.3</div>
<div class="line">[1050]  : 2024-05-03 09:19:44 +0000</div>
<div class="line">Wi-Fi Connection Manager initialized.</div>
<div class="line">Connecting to Wi-Fi Network: ACTFIBERNET</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 0 #######</span></div>
<div class="line">Connecting to AP ...</div>
<div class="line">######### Received <span class="keyword">event</span> changed from wcm, <span class="keyword">event</span> = 1 #######</div>
<div class="line">Connected to AP and network is up !!</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 5 #######</span></div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Successfully connected to Wi-Fi network <span class="stringliteral">&#39;ACTFIBERNET&#39;</span>.</div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Connected AP details Channel: 6, Channel width: 20, Signal strength(dBm): -13</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Received character 7</div>
<div class="line">Sleep unlocked</div>
</div><!-- fragment --></li>
<li>Use a PC to connect to the same Wi-Fi AP as the CYW955913EVK-01 board.<ul>
<li>Send a "ping" command to the board and observe in the serial <div class="fragment"><div class="line">C:\&gt;ping -n 3 192.168.39.170</div>
<div class="line"> </div>
<div class="line">Pinging 192.168.39.170 with 32 bytes of data:</div>
<div class="line">Reply from 192.168.39.170: bytes=32 time=319ms TTL=255</div>
<div class="line">Reply from 192.168.39.170: bytes=32 time=233ms TTL=255</div>
<div class="line">Reply from 192.168.39.170: bytes=32 time=151ms TTL=255</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.39.170:</div>
<div class="line">  Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div>
<div class="line">Approximate round trip times in milli-seconds:</div>
<div class="line">  Minimum = 151ms, Maximum = 319ms, Average = 234ms</div>
<div class="line"> </div>
<div class="line">&lt;Terminal logs &gt;</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the CYW955913EVK-01 is in Deep Sleep mode. </p><div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 192.168.39.170</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.39.170 in 113.078ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.39.170 in 1115.498ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.39.170 in 1113.863ms</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.39.170/arp</div>
<div class="line">   3 probes sent.</div>
<div class="line">   3 successful, 0 failed.</div>
<div class="line">Approximate trip times in milli-seconds:</div>
<div class="line">   Minimum = 113.078ms, Maximum = 1115.498ms, Average = 780.813ms</div>
</div><!-- fragment --><p class="startli">Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address]</li>
</ul>
<p class="startli">Because the WLAN device’s ARP cache is empty on the initial ARP request from the peer, it looks up the IP details from the host and updates its ARP cache. This causes the host to wake up because of network activity between the host MCU and the WLAN device. On subsequent ARP requests from the peer, the host remains asleep. The WLAN device continues to respond to the ARP request as it has the ARP data available in its ARP cache.</p>
</li>
</ul>
</li>
<li>Verify the ARP offload is working as desired. Refer to <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power/blob/master/README.md"><b>README.md</b></a> of mtb-example-threadx-cyw5591x-low-power application for instructions to measure power. While the Wi-Fi subsystem responds to each request, the host MCU is in System Deep Sleep mode.</li>
<li>Disable the ARP Offload feature and observe that the CYW955913EVK-01 wakes up on each request. Launch the ModusToolbox&trade; Device Configurator and open the appropriate design.modus file. Select the "CYW55913IUBGT" tab, select Power-&gt;Wi-Fi personality, and disable ARP offload by deselecting the check box next to "ARP offload". Save the configuration. Then, build and program the application. With ARP offload disabled, the CYW955913EVK-01 host wakes up for every ARP request.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_packet_filter"></a>
Wi-Fi Packet filter offload</h2>
<p >Packet filters allow the host processor to limit which types of packets get passed up to the host processor from the WLAN subsystem. This is useful to keep out unrequired packets from the network that might otherwise wake the host out of a power-saving System Deep Sleep mode or prevent it from entering the System Deep Sleep mode.</p>
<p >Packet filters are useful when:</p><ul>
<li>Trying to keep the host processor in the System Deep Sleep mode for as long as possible.</li>
<li>Trying to get the host processor into System Deep Sleep mode as soon as possible.</li>
</ul>
<p >Whenever a WLAN packet is destined for the host, the WLAN processor must awaken the host (if it is asleep) so it can retrieve the packet for processing. Often times the host network stack processes the packet only to discover that the packet should be thrown away, because it is not needed. For example, it is destined for a port or service that is being used. Packet filters allow these types of packets to be filtered and discarded by the WLAN processor so the host is not interrupted.</p>
<p >All packet filters are enabled after Wi-Fi connection is established. So that the application is not required to create any filters specific for connectection establishment.</p>
<h3><a class="anchor" id="group_lpa_p2_filtertypes"></a>
Filter types</h3>
<p >The following types of packet filters are supported, based on a standard IP Stack:</p>
<div class="image">
<img src="PacketFiletr.png" alt="" height="200px"/>
</div>
<p >A general purpose STA might want these types of packets:</p><ul>
<li>Ether type ARP</li>
<li>IP protocol ICMP</li>
<li>TCP port 22 (ssh)</li>
<li>UDP port 68 (DHCP)</li>
</ul>
<p >Other packet types are highly dependent on what applications and data types are in use. Multiple filters may be configured to operate simultaneously.</p>
<p ><b>Network layer/Ether types</b></p>
<p >The EtherType filter is based on a 16-bit ethertype field present in ethernet packets, and it is the lowest level of the TC/IP stack. A technical description and list of choices can be found in numerous places, such as <a href="https://en.wikipedia.org/wiki/EtherType"><b>Ether Type</b></a>.</p>
<p >The most commonly used protocols (and most useful filters) are:</p><ul>
<li>IP (value 0x800)</li>
<li>ARP (value 0x806).</li>
</ul>
<p >Filtering on IP would match any and all IP packets coming from the network. This is a very coarsely grained filter and it will include all ICMP, TCP, and UDP packets as shown in the diagram above. Filtering on ARP is finer grained, and it will only match on ARP packets. Filtering all IP will have an enormous impact due to the large number of packets it will match and is generally not recommended for general usage.</p>
<p >Valid EtherType filters consist of a 16-bit number greater than or equal to 0x800.</p>
<p ><b>Transport layer/IP protocols</b></p>
<p >The next layer up the stack is the Transport layer, which consists of various IP protocols such as TCP, UDP, and ICMP. Discussions of the protocols themselves are outside the realm of this document, but are widely available. A list of protocol numbers is also widely available, including: <a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers"><b>IP Protocol numbers</b></a>.</p>
<p >IP protocol filters consist of a single 8-bit number. No checking is done to see if this number matches a well-known protocol because it is possible for vendors to use proprietary numbers and protocols.</p>
<p >Filtering on one IP protocol will only match that protocol. For example, filtering on UDP would match a UDP packet, but not ICMP or TCP packets. However, matching on TCP is still very coarsely grained and will likely include the majority of packets destined for the host processor (depending on your environment). Port numbers are the next level of filter refinement.</p>
<p ><b>NOTE:</b> If application needs to perform ping, then along with IP protocol filter for ICMP, ethertype ARP filter has to be enabled for address resolution.</p>
<p ><b>Applications Layer / TCP &amp; UDP Port Numbers</b></p>
<p >The applications layer distinguishes between various applications based on port numbers. These are simply well-known numbers used to identify various TCP and UDP-based applications. Technical discussions about port numbers and list of numbers that belong to which applications can be found widely on the internet, for example: <a href="https://en.wikipedia.org/wiki/List_of_TCP_and_UDP_port_numbers"><b>TCP and UDP port numbers</b></a>.</p>
<p >Port filters are 16-bit port numbers as described above. With a port number filter, you can filter on, for example, only ssh packets (port 22), only on ftp packets (port 20), or any other of the many applications listed above.</p>
<p >Due to the large number and constantly changing port definitions, the OLM makes no attempt to sanity check these values.</p>
<p >IP packets have both source and destination ports. Destination ports are the well-known port numbers described in the link above and generally the most useful. Source ports describe the temporary, ephemeral port numbers used by the host sending the packets. These are generated on the fly and not well known. Because they are not known ahead of time, creating a filter for them is difficult. Port ranges can be used to match a wide range of source ports to cover this case.</p>
<p >Port filters support optional port ranges. A port range describes a start and end such that any port number within that start-end range will match. This is most useful for matching a short-lived ephemeral source port number since it will not be known ahead of time.</p>
<p >Because both TCP and UDP use port numbers, filters are configured to match one or the other (TCP or UDP). If both TCP and UDP need to be filtered for a particular port, two filters can be created; one for each.</p>
<h3><a class="anchor" id="group_lpa_p2_keeptoss"></a>
Action (keep vs toss)</h3>
<p >Filters can be configured to either keep (send to host) or toss (drop/discard). When configured to drop, only the specified packets are dropped, while any others not specifically filtered are passed to the host. Likewise, when configured to keep packets, only the specified packets are passed to the host, and the rest are discarded. The most helpful model is to use only 'keep' filters. In other words, use 'keep' filters to specify the complete list of packet types that the host is interested in, and discard the rest. This works because it is much simpler to list the packets that the host wants to receive than to create a complete list of packets it does not want.</p>
<p >When using keep filters, use care to allow enough packets through for networking protocols to work properly. For instance, the processor must be able to join a network, get a DHCP address, respond to ARP requests, and possibly share network keys. Hence all filters are enabled after Wi-Fi connection. A reasonable minimal set of keep filter includes:</p><ul>
<li>Keep, EtherType 0x806 #Allow ARP through</li>
</ul>
<p >The following additional filters might also be needed depending on the application:</p><ul>
<li>Keep, Port Filter: TCP Dest Port 8883 #Allow Secure MQTT packets</li>
<li>Keep, Port Filter: TCP Dest Port 1883 #Allow Open MQTT packets</li>
</ul>
<p >These 'keep' filters will keep only the packet types as described; all other traffic will be discarded so it is critical to use enough filters to allow the application to receive the traffic it needs. This type of configuration is useful when the system receives many different kinds of traffic and it is easier to describe the traffic to be kept rather than the traffic to be discarded.</p>
<p >Alternatively, it is often simpler to describe the specific type of traffic to be discarded and keeping everything else. For example, someone on the network keeps pinging your machine (using ICMP packets) and waking it. You want to block ICMP and keep everything else. In this case, the following one filter is needed:</p><ul>
<li>Discard, IPType 1 # toss ICMP packet</li>
</ul>
<p >This discards all incoming ping/ICMP packets and keep all other traffic.</p>
<p >There are no minimal filters for toss filters because the system filters the specific packets and everything else gets passed up to the host.</p>
<p ><b>Note</b> All active filters need to be of the same type (keep or toss). Mixing active keep and toss filters will cause unexpected behaviors.</p>
<p >The following diagram shows packet filter offload with ICMP packet configured to be discarded:</p>
<div class="image">
<img src="pf_ping_packet_discard.png" alt="" height="500px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_sleepwake"></a>
When Active (Sleep vs Wake)</h3>
<p >Filters can be configured to be active either when the host processor is active or asleep, or both. When a filter is not active, it has no effect. When the system goes into sleep mode, it disables all wake filters and enables all sleep filters just before entering sleep. When waking, all sleep filters are disabled and wake filters enabled.</p><ul>
<li>Wake filters allow the host to go into sleep mode faster.</li>
<li>Sleep filters help the host stay asleep longer.</li>
</ul>
<p >Normally, without packet filters, the WLAN subsystem passes all packets destined for the host up to the host network stack for processing. If the host is in System Deep Sleep, the WLAN subsystem will first wake the host and then pass the packet up to the stack. From there, the network stack will pass the packet on to the application that is listening for that type of packet. If no applications are listening for that type of packet, the network stack drops the packet.</p>
<p >For example,</p><ul>
<li>An http packet arrives on port 80, but there is no http server running that would read the packet (port 80 is default http port).</li>
<li>An ssh packet arrives on port 22, but there is no ssh server running that would read that packet (port 22 is default ssh port).</li>
</ul>
<p >In both cases, the host would awaken from its battery-saving System Deep Sleep mode to drop a packet. It is not hard to imagine scenarios where traffic your application doesn't want or doesn't care about ends up penalizing your battery usage by constantly waking the host from System Deep Sleep. Alternatively, these unwanted packets can also prevent the host from entering System Deep Sleep mode in the first place. The host has an idle sleep threshold. When the host has been idle longer than that threshold, it puts itself to sleep. Processing unwanted packets (even just dropping them) causes the host to come out of idle and prevents it from reaching the idle sleep threshold, preventing the host from entering sleep. In both cases, traffic patterns keep the processor awake, burning power.</p>
<h3><a class="anchor" id="group_lpa_p2_packet_filter_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the Packet Filter feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p ><b>PSoC&trade; 6</b></p>
<p >Follow the below steps for application creation and offload verification.</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Configure Packet Filters. The easiest way to configure Packet Filters is to use the ModusToolbox&trade; Device Configurator. <br  />
<ul>
<li>Refer section <a class="el" href="index.html#group_lpa_p2_cc_hostwake">Wi-Fi host wake configuration</a> to verify WLAN_HOST_WAKE pin configurations using device configurator.</li>
<li>In design.modus, switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable "Filter configuration" with below configurations. These filters allow TCP packets and any other Wi-Fi packets are dropped by WLAN chip and not forwarded to the host MCU (PSoC&trade; 6).<ul>
<li>Filter Type: IP type</li>
<li>Action: Keep</li>
<li>IP Protocol: 0x06 to the host MCU (PSoC&trade; 6)</li>
</ul>
</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Execute following command to build and program the application. Below is example for the CY8CKIT_062S2_43012 Board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make build TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application starts, the console output shows that it connects to the specified Wi-Fi AP, and then the PSoC&trade; 6 MCU goes to System Deep Sleep mode. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Check the board operation. Use a PC to connect to the same Wi-Fi AP as the PSoC&trade; 6 board.<ul>
<li>Send "ping" command to the board and observe in serial terminal that it does not wake up the PSoC&trade; 6 MCU because there is no "keep" packet filter for ICMP pings, there is no response for the pings: <div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div>
<div class="line"> </div>
<div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div>
<div class="line">Request timed out.</div>
<div class="line">Request timed out.</div>
<div class="line">Request timed out.</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div>
<div class="line">    Packets: Sent = 3, Received = 0, Lost = 3 (100% loss),</div>
</div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the PSoC&trade; 6 MCU is in Deep Sleep mode. Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address] <div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 10.0.0.201</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 113.209ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 125.789ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 10.0.0.201 in 1114.333ms</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201/arp</div>
<div class="line">    3 probes sent.</div>
<div class="line">    3 successful, 0 failed.</div>
<div class="line">Approximate trip times in milli-seconds:</div>
<div class="line">    Minimum = 113.209ms, Maximum = 1114.333ms, Average = 451.111ms</div>
</div><!-- fragment --></li>
</ul>
<p class="startli">Observe that PSoC&trade; 6 MCU wakes up for each command because there is "keep" packet filter for ARP pings, the ARP pings are responded back: </p><div class="fragment"><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
</ul>
</li>
<li><p class="startli">Verify that the packet Filter is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to measure power consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with the Packet Filter enabled:</p>
<p class="startli">i. ARP Ping : This wakes up the host as packet filter for ARP is configured.</p>
</li>
</ol>
<div class="image">
<img src="FreeRTOS_PF_ARP_ping.png" alt="" height="500px"/>
</div>
<p >ii. Ping : This does not wakeup the host as ICMP packet is not configured as packet filter type. </p><div class="image">
<img src="FreeRTOS_PF_ping_nowake.png" alt="" height="500px"/>
</div>
<p ><b>CYW955913EVK-01</b></p>
<p >Follow the below steps for application creation and offload verification.</p>
<ol type="1">
<li>Create existing Code Example <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power"><b>mtb-example-threadx-cyw5591x-low-power</b></a> available in the ModusToolbox&trade; environment for <b>CYW955913EVK-01</b> device.</li>
<li>MCU low power is enabled by default in CYW955913EVK-01.</li>
<li>Modify the <b>WIFI_SSID</b> and <b>WIFI_PASSWORD</b> in <em>wifi_functions.h</em> to the desired Access Point.</li>
<li>Configure Packet Filters. The easiest way to configure Packet Filters is to use the ModusToolbox&trade; Device Configurator. <br  />
<ul>
<li>In design.modus, switch to the connectivity device "CYW55913IUBGT" tab</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>Enable "Filter configuration" with below configurations. These filters allow TCP packets and any other Wi-Fi packets are dropped by WLAN chip and not forwarded to the host MCU.<ul>
<li>Filter Type: IP type</li>
<li>Action: Keep</li>
<li>IP Protocol: 0x06 to the host MCU</li>
</ul>
</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li>Execute following command to build and program the application: <div class="fragment"><div class="line">make build TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li><p class="startli">When the application starts, the console output shows a list of options. Press '2' to connect to the pre-defined Access Point.</p>
<dl class="section note"><dt>Note</dt><dd>As part of Wi-Fi connection, the offload gets initialized.</dd></dl>
</li>
<li>Once the device connects to AP, press '7' to release the sleep lock which allows the system to enter deep sleep. <div class="fragment"><div class="line">************************************************************************</div>
<div class="line">                   Low Power Application Start</div>
<div class="line"> ************************************************************************</div>
<div class="line">********************* Available Commands *******************************</div>
<div class="line">**1) Press <span class="charliteral">&#39;1&#39;</span> to initialize WLAN  *************************************</div>
<div class="line">**2) Press <span class="charliteral">&#39;2&#39;</span> to connect to a predefined AP ***************************</div>
<div class="line">**3) Press <span class="charliteral">&#39;3&#39;</span> to start iperf session **********************************</div>
<div class="line">**4) Press <span class="charliteral">&#39;4&#39;</span> to initialize Bluetooth *********************************</div>
<div class="line">**5) Press <span class="charliteral">&#39;5&#39;</span> to start Bluetooth LE advertisements ********************</div>
<div class="line">**6) Press <span class="charliteral">&#39;6&#39;</span> to lock sleep *******************************************</div>
<div class="line">**7) Press <span class="charliteral">&#39;7&#39;</span> to allow sleep ******************************************</div>
<div class="line">**8) Press <span class="charliteral">&#39;8&#39;</span> to disconnect from the AP *******************************</div>
<div class="line">**9) Press <span class="charliteral">&#39;9&#39;</span> any time in application to start scan *******************</div>
<div class="line">*10) Press <span class="charliteral">&#39;t&#39;</span> to initiate a connection to pre-configured TCP server****</div>
<div class="line">*11) Press <span class="charliteral">&#39;h&#39;</span> any time in application to print the menu****************</div>
<div class="line">************************************************************************</div>
<div class="line">Setting up wake source</div>
<div class="line">Received character 2</div>
<div class="line"> </div>
<div class="line">[1040] WLAN MAC Address : 00:A0:50:73:E9:C6</div>
<div class="line"> </div>
<div class="line">[1040] WLAN Firmware    : wl0: Apr 30 2024 06:00:23 version 28.10.212 (b71ca01) FWID 01-f5464446</div>
<div class="line"> </div>
<div class="line">[1040] WLAN CLM         : API: 20.0 Data: IFX.BRANCH_18_53 Compiler: 1.49.5 ClmImport: 1.48.0 Customization: v3 24/04/08 Creation: 2024-04-29 22:07:56</div>
<div class="line"> </div>
<div class="line">[1040] WHD VERSION      : 300.3.0.23648</div>
<div class="line">[1040]  : EAP v300.3.0</div>
<div class="line">[1050]  : GCC 11.3</div>
<div class="line">[1050]  : 2024-05-03 09:19:44 +0000</div>
<div class="line">Wi-Fi Connection Manager initialized.</div>
<div class="line">Connecting to Wi-Fi Network: ACTFIBERNET</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 0 #######</span></div>
<div class="line">Connecting to AP ...</div>
<div class="line">######### Received <span class="keyword">event</span> changed from wcm, <span class="keyword">event</span> = 1 #######</div>
<div class="line">Connected to AP and network is up !!</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 5 #######</span></div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Successfully connected to Wi-Fi network <span class="stringliteral">&#39;ACTFIBERNET&#39;</span>.</div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Connected AP details Channel: 6, Channel width: 20, Signal strength(dBm): -13</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Received character 7</div>
<div class="line">Sleep unlocked</div>
</div><!-- fragment --></li>
<li>Use a PC to connect to the same Wi-Fi AP as the CYW955913EVK-01 board.<ul>
<li>Send "ping" command to the board and observe in serial terminal that it does not wake up the MCU (CM33) because there is no "keep" packet filter for ICMP pings, there is no response for the pings: <div class="fragment"><div class="line">C:\&gt;ping -n 3 192.168.39.170</div>
<div class="line"> </div>
<div class="line">Pinging 192.168.39.170 with 32 bytes of data:</div>
<div class="line">Request timed out.</div>
<div class="line">Request timed out.</div>
<div class="line">Request timed out.</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.39.170:</div>
<div class="line">    Packets: Sent = 3, Received = 0, Lost = 3 (100% loss),</div>
</div><!-- fragment --></li>
<li><p class="startli">Send an "arping" command as follows and observe that the MCU is in Deep Sleep mode. </p><div class="fragment"><div class="line">C:\&gt;arp-ping.exe -n 3 192.168.39.170</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.39.170 in 113.209ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.39.170 in 125.789ms</div>
<div class="line">Reply that D4:4D:A4:A0:02:A4 is 192.168.39.170 in 1114.333ms</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 192.168.39.170/arp</div>
<div class="line">    3 probes sent.</div>
<div class="line">    3 successful, 0 failed.</div>
<div class="line">Approximate trip times in milli-seconds:</div>
<div class="line">    Minimum = 113.209ms, Maximum = 1114.333ms, Average = 451.111ms</div>
</div><!-- fragment --><p class="startli">Use any available ARPping tool. As an example:</p><ul>
<li>Windows: <a href="https://www.elifulkerson.com/projects/arp-ping.php">https://www.elifulkerson.com/projects/arp-ping.php</a></li>
<li>Mac : <a href="http://macappstore.org/arping/">http://macappstore.org/arping/</a></li>
<li>linux : sudo apt install arping; arping [ip address]</li>
</ul>
<p class="startli">Observe that CYW955913EVK-01 wakes up for each command because there is "keep" packet filter for ARP pings, the ARP pings are responded back: </p><div class="fragment"><div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 2456ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:174, rx_total:198, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2638, cmd53_read:1001, cmd53_write:796</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:199, sdio_intrs:401, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Verify that the packet Filter is working as desired. Refer to <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power/blob/master/README.md"><b>README.md</b></a> of mtb-example-threadx-cyw5591x-low-power application for instructions to measure power.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_tcp_keepalive"></a>
Wi-Fi TCP keepalive offload</h2>
<p >TCP keepalive offload part of the LPA is designed to improve the power consumption of the connected system by reducing the time the host needs to stay awake to support TCP keepalive request. This document describes how to enable TCP keepalive offload and configure four different sockets for TCP keepalive that can be incorporated into the project from <a href="https://github.com/Infineon/lpa"><b>Infineon GitHub LPA Middleware</b></a>.</p>
<p >TCP keepalive maintains idle TCP connections by periodically passing packets between the client and server. If either the client or server does not respond to a packet, the connection is considered inactive and is terminated. This helps in pruning dead connections. Typically TCP keepalives are sent every 45 or 60 seconds on an idle TCP connection, and the connection is dropped after three sequential ACKs are missed. This means host MCU has to wake up periodically to send TCP keepalive packet to maintain TCP connection during idle state.</p>
<p >TCP keepalive offload helps in moving this functionality to WLAN firmware so that host MCU does not need to wake up periodically to send/receive TCP keepalive packets. This functionality is offloaded only when host MCU goes to Sleep mode and network stack is suspended.</p>
<div class="image">
<img src="TCP_Keepalive_basic_graph.png" alt="" height="500px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_tcp_keepalive_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the TCP keepalive offload feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p ><b>PSoC&trade; 6</b></p>
<p >Do the following to set up the wifi-low-power tcp keepalive offload example and enable the TCP keepalive offload feature.</p>
<ol type="1">
<li>Refer readme of <a href="https://github.com/Infineon/mtb-example-wlan-offloads.git"><b> mtb-example-wlan-offloads</b></a> for project creation.</li>
<li><p class="startli">Configure TCP keepalive offload. The easiest way to configure TCP keepalive offload is to use the ModusToolbox&trade; Device Configurator.</p><ul>
<li><u>Configuring TCP keepalive offload on CY8CEVAL-062S2-CYW43022CUB and CY8CEVAL-062S2-CYW955513SDM2WLIPA:</u> <br  />
<ul>
<li>Only responder mode is supported for this device. i.e. WLAN firmware will send the TCP keep-alive response to the TCP keep-alive request coming from the server. No configuration parameters for TCPKA offolad in ModusToolbox&trade; Device Configurator is needed.</li>
</ul>
</li>
<li><u>Configuring TCP keepalive offload on all other kits:</u> <br  />
<ul>
<li>Refer section <a class="el" href="index.html#group_lpa_p2_cc_hostwake">Wi-Fi host wake configuration</a> to verify WLAN_HOST_WAKE pin configurations using the Device Configurator.</li>
<li>In design.modus, switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable TCP keepalive offload.</li>
<li>Configure Interval, Retry Interval, and Retry Count.</li>
<li>Configure Source port, Destination port, and Destination IP address (TCP server).</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
</ul>
<p class="startli">ii. Manual configuration steps</p><ul>
<li>Read the OLM configuration from device configurator and make a copy of OLM device configurator <a class="el" href="index.html#subsection_lpa_snippet_2">Code Snippet 2: Read OLM configuration from device configurator.</a></li>
<li>search for "TKO" name in the device configurator list, if present then use it establish TCP connection <a class="el" href="index.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>If TCP Keep-alive offload is not present in device configurator then add TCP keep-alive offload list <a class="el" href="index.html#subsection_lpa_snippet_3">Code Snippet 3: Search for TCP KA offload in the device configurator list.</a></li>
<li>Establish TCP connection <a class="el" href="index.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a></li>
<li>TCP keepalive offload will be enabled when host MCU goes to sleep <a class="el" href="index.html#subsection_lpa_snippet_1">Code Snippet 1: Using wait_net_suspend for suspend/resume network stack</a></li>
<li><b>Note</b> The maximum supported TCP connections that can be offloaded to WLAN device is 4 (MAX_TKO) this is WLAN firmware limitation, if the API <a class="el" href="index.html#subsection_lpa_snippet_5">Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</a> is invoked more than 4 times then LIFO ( Last In First Out) Algorithm is followed where the MRU(Most Recently Used) TCP connections will only be offloaded to WLAN device.</li>
</ul>
</li>
<li>Use a PC to connect to the same Wi-Fi Access Point as the PSoC&trade; 6 board. Run <a href="tcp_echo_server.py" rel="stylesheet" type="text/css"><b>tcp_echo_server.py</b></a> in that PC to act as TCP Server <div class="fragment"><div class="line">python tcp_echo_server.py --port 3360</div>
</div><!-- fragment --></li>
<li><p class="startli">Refer mtb-example-connectivity-offload-tcp-keepalive <a href="https://github.com/Infineon/mtb-example-connectivity-offload-tcp-keepalive/blob/master/README.md"><b>readme</b></a> to build the project and program the board. The following command is an example for the CY8CKIT_062S2_43012 board, using GCC_ARM as the toolchain: </p><div class="fragment"><div class="line">make getlibs</div>
<div class="line">make program TARGET=CY8CKIT-062S2-43012 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --><p class="startli">When the modified mtb-example-connectivity-offload-tcp-keepalive starts, the console output lists available Wi-Fi networks. It then connects to the specified above Wi-Fi AP, and then the PSoC&trade; 6 MCU goes to System Deep Sleep mode. </p><div class="fragment"><div class="line">Info: ============================================</div>
<div class="line">Info:  Example: WLAN TCP Keepalive Offload</div>
<div class="line">Info: ============================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Wi-Fi initialization is successful</div>
<div class="line">Join to AP: SSID</div>
<div class="line">IP Address 192.168.43.11 assigned</div>
<div class="line">Successfully joined wifi network SSID</div>
<div class="line">Taking TCP Keepalive configuration from the Generated sources.</div>
<div class="line">TCP remote IP Address f2ba8c0  remote port:3360</div>
<div class="line">TCP Connection Established Successfully ctx:8011050</div>
<div class="line">Socket[0]: Created connection to IP 192.168.43.15, local port 3353, remote port 3360</div>
<div class="line">Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[1]. Check the TCP Keepalive configuration.</div>
<div class="line">Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[2]. Check the TCP Keepalive configuration.</div>
<div class="line">Skipped TCP socket connection <span class="keywordflow">for</span> socket <span class="keywordtype">id</span>[3]. Check the TCP Keepalive configuration.</div>
<div class="line">Low power task created</div>
<div class="line">whd_tko_toggle: Successfully enabled</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Verify that the TCP keepalive offload is working as desired. Refer to the <a class="el" href="index.html#section_lpa_measurement">How to measure power consumption</a> section for corresponding instructions. The following oscilloscope screen capture shows current measurement with</li>
</ol>
<p ><b>TCP keepalive offload enabled with 20 seconds interval configuration and WLAN DTIM configured as 3 :</b> </p><div class="image">
<img src="FreeRTOS_TKO_Enable.png" alt="" height="500px"/>
</div>
<p ><b>CYW955913EVK-01</b></p>
<p >Do the following to set up the <em>mtb-example-threadx-cyw5591x-low-power</em> example and enable the TCP keepalive offload feature.</p>
<ol type="1">
<li>Create existing Code Example <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power"><b>mtb-example-threadx-cyw5591x-low-power</b></a> available in the ModusToolbox&trade; environment for <b>CYW955913EVK-01</b> device.</li>
<li>MCU low power is enabled by default in CYW955913EVK-01.</li>
<li>Modify the <b>WIFI_SSID</b> and <b>WIFI_PASSWORD</b> in <em>wifi_functions.h</em> to the desired Access Point.</li>
<li>Configure TCP keepalive offload. The easiest way to configure TCP keepalive offload is to use the ModusToolbox&trade; Device Configurator.<ul>
<li>Only responder mode is supported for this device. i.e. WLAN firmware will send the TCP keep-alive response to the TCP keep-alive request coming from the server. No configuration parameters for TCPKA offolad in ModusToolbox™ Device Configurator is needed.</li>
</ul>
</li>
<li>Execute following command to build and program the application: <div class="fragment"><div class="line">make build TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CYW955913EVK-01 TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li><p class="startli">When the application starts, the console output shows a list of options. Press '2' to connect to the pre-defined Access Point.</p>
<dl class="section note"><dt>Note</dt><dd>As part of Wi-Fi connection, the offload gets initialized.</dd></dl>
<p>7.</p><ul>
<li>Use a PC to connect to the same Wi-Fi Access Point as the board. Run <a href="tcp_echo_server.py" rel="stylesheet" type="text/css"><b>tcp_echo_server.py</b></a> in that PC to act as TCP Server <div class="fragment"><div class="line">python tcp_echo_server.py --port 3360</div>
</div><!-- fragment --></li>
<li>Press 't' option to connect to the pre-configured TCP server.</li>
</ul>
</li>
<li>Press '7' to release the sleep lock which allows the system to enter deep sleep. <div class="fragment"><div class="line">************************************************************************</div>
<div class="line">                   Low Power Application Start</div>
<div class="line"> ************************************************************************</div>
<div class="line">********************* Available Commands *******************************</div>
<div class="line">**1) Press <span class="charliteral">&#39;1&#39;</span> to initialize WLAN  *************************************</div>
<div class="line">**2) Press <span class="charliteral">&#39;2&#39;</span> to connect to a predefined AP ***************************</div>
<div class="line">**3) Press <span class="charliteral">&#39;3&#39;</span> to start iperf session **********************************</div>
<div class="line">**4) Press <span class="charliteral">&#39;4&#39;</span> to initialize Bluetooth *********************************</div>
<div class="line">**5) Press <span class="charliteral">&#39;5&#39;</span> to start Bluetooth LE advertisements ********************</div>
<div class="line">**6) Press <span class="charliteral">&#39;6&#39;</span> to lock sleep *******************************************</div>
<div class="line">**7) Press <span class="charliteral">&#39;7&#39;</span> to allow sleep ******************************************</div>
<div class="line">**8) Press <span class="charliteral">&#39;8&#39;</span> to disconnect from the AP *******************************</div>
<div class="line">**9) Press <span class="charliteral">&#39;9&#39;</span> any time in application to start scan *******************</div>
<div class="line">*10) Press <span class="charliteral">&#39;t&#39;</span> to initiate a connection to pre-configured TCP server****</div>
<div class="line">*11) Press <span class="charliteral">&#39;h&#39;</span> any time in application to print the menu****************</div>
<div class="line">************************************************************************</div>
<div class="line">Setting up wake source</div>
<div class="line">Received character 2</div>
<div class="line"> </div>
<div class="line">[1040] WLAN MAC Address : 00:A0:50:73:E9:C6</div>
<div class="line"> </div>
<div class="line">[1040] WLAN Firmware    : wl0: Apr 30 2024 06:00:23 version 28.10.212 (b71ca01) FWID 01-f5464446</div>
<div class="line"> </div>
<div class="line">[1040] WLAN CLM         : API: 20.0 Data: IFX.BRANCH_18_53 Compiler: 1.49.5 ClmImport: 1.48.0 Customization: v3 24/04/08 Creation: 2024-04-29 22:07:56</div>
<div class="line"> </div>
<div class="line">[1040] WHD VERSION      : 300.3.0.23648</div>
<div class="line">[1040]  : EAP v300.3.0</div>
<div class="line">[1050]  : GCC 11.3</div>
<div class="line">[1050]  : 2024-05-03 09:19:44 +0000</div>
<div class="line">Wi-Fi Connection Manager initialized.</div>
<div class="line">Connecting to Wi-Fi Network: ACTFIBERNET</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 0 #######</span></div>
<div class="line">Connecting to AP ...</div>
<div class="line">######### Received <span class="keyword">event</span> changed from wcm, <span class="keyword">event</span> = 1 #######</div>
<div class="line">Connected to AP and network is up !!</div>
<div class="line"><span class="preprocessor">######### Received event changed from wcm, event = 5 #######</span></div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Successfully connected to Wi-Fi network <span class="stringliteral">&#39;ACTFIBERNET&#39;</span>.</div>
<div class="line">IP Address: 192.168.39.170</div>
<div class="line">Connected AP details Channel: 6, Channel width: 20, Signal strength(dBm): -13</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line"> </div>
<div class="line">Received character t</div>
<div class="line">Taking TCP Keepalive configuration from the Generated sources.</div>
<div class="line">TCP remote IP Address f2ba8c0  remote port:3360</div>
<div class="line">TCP Connection Established Successfully ctx:8011050</div>
<div class="line">Socket[0]: Created connection to IP 192.168.39.15, local port 3353, remote port 3360</div>
<div class="line">Skipped TCP socket connection for socket id[1]. Check the TCP Keepalive configuration.</div>
<div class="line">Skipped TCP socket connection for socket id[2]. Check the TCP Keepalive configuration.</div>
<div class="line">Skipped TCP socket connection for socket id[3]. Check the TCP Keepalive configuration.</div>
<div class="line">whd_tko_toggle: Successfully enabled</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line"> </div>
<div class="line">Received character 7</div>
<div class="line">Sleep unlocked</div>
</div><!-- fragment --></li>
<li>Verify that the TCP keepalive offload is working as desired. Refer to <a href="https://github.com/Infineon/mtb-example-threadx-cyw5591x-low-power/blob/master/README.md"><b>README.md</b></a> of mtb-example-threadx-cyw5591x-low-power application for instructions to measure power.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_dltro"></a>
DHCP Lease Time Renew offload</h2>
<p >DHCP (Dynamic Host Configuration Protocol) is a network management protocol used to dynamically assign an IP address to any device on a network so it can communicate using IP. DHCP automates the assigning of IP addresses to all network devices.</p>
<p >DHCP enabled clients will send DHCP broadcast message (DHCP Discover). DHCP server in the network responds to the client with DHCP offer containing IP configuration information such as default gateway, IP address, DNS server IP address and lease time period. DHCP client responds to DHCP offer with DHCP request message to accept the IP address. DHCP server confirms it by responding with DHCP ACk. The granted IP address is valid for lease time interval. DHCP clients are responsible for renewing the IP address by sending the DHCP request periodically before lease expires.</p>
<p >With DHCP Lease Time Renew offload, WLAN firmware intercepts DHCP Offer and records DHCP lease time. When MCU is in sleep state, firwmare will send DHCP Request to DHCP server before DHCP lease time expiry. This will reduce the overhead on MCU to wake-up everytime when DHCP lease time expires. When MCU is in wake state, DHCP renew packet is sent by network stack running on host.</p>
<div class="image">
<img src="DLTRO_Offload.JPG" alt="" height="350px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_dltro_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to use the DLTRO feature in the RTOS environment and its impact on the system power consumption.</p>
<p >DLTRO is supported on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA, CYW955913EVK-01 and KIT_PSE84_EVAL_EPC2 devices.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Open design.modus file and do the following configuration settings in the ModusToolbox&trade; Device Configurator.<ul>
<li>switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Select Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Save the configuration to generate the necessary code.</li>
<li>DLTRO is enabled by default in the WLAN firmware. Hence user is not required to do any configuration settings in ModusToolbox&trade; Device Configurator.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Execute following command to build and program the application. <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>Configure DHCP lease time in the Access Point. Otherwise it will send at default value that is configured in Router.</li>
<li>When the application executes, the console output shows that it connected to the specified Wi-Fi AP, network stack is suspended and PSoC&trade; 6 MCU and WLAN goes to low power mode. As part of this offloads will be enabled. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Verify in wireshark the DHCP request is sent periodically from WLAN firmware without waking up the host. <div class="image">
<img src="DLTRO_Wireshark.jpg" alt="" height="250px"/>
</div>
</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_icmp"></a>
ICMP offload</h2>
<p >The Internet Control Message Protocol (ICMP) is a network layer protocol used by network devices to diagnose network communication issues. ICMP is mainly used to determine whether or not data is reaching its intended destination by sending ICMP request to the specific IP address and receive the ICMP response in a timely manner.</p>
<p >With ICMP offload, WLAN firmware will respond to the ICMP ECHO request by sendig PING ECHO response packet to the peer without waking up the host processor allowing the host to stay is sleep state for longer duration.</p>
<p >ICMP offload is active during host wake state and sleep state.</p>
<div class="image">
<img src="ICMP_Offload.JPG" alt="" height="350px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_icmp_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to use the ICMP offload feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p >ICMP offload is supported on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA, CYW955913EVK-01 and KIT_PSE84_EVAL_EPC2 devices. Follow below steps for ICMP offload testing on CYW43022CUB device.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Open design.modus file and do the following configuration settings in the ModusToolbox&trade; Device Configurator.<ul>
<li>switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Select Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Save the configuration to generate the necessary code.</li>
<li>ICMP offload is enabled by default in the WLAN firmware. Hence user is not required to do any configuration settings in ModusToolbox&trade; Device Configurator.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Execute following command to build and program the application. <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application executes, the console output shows that it connected to the specified Wi-Fi AP, network stack is suspended and PSoC&trade; 6 MCU and WLAN goes to low power mode. As part of this offloads will be enabled. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Verify in wireshark the ping response is sent from WLAN firmware without waking up the host. Send a "ping" command to the board and observe MCU does not wake up for ping. <div class="fragment"><div class="line">C:\&gt;ping -n 3 10.0.0.201</div>
<div class="line">Pinging 10.0.0.201 with 32 bytes of data:</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=274ms TTL=255</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=393ms TTL=255</div>
<div class="line">Reply from 10.0.0.201: bytes=32 time=396ms TTL=255</div>
<div class="line"> </div>
<div class="line">Ping statistics <span class="keywordflow">for</span> 10.0.0.201:</div>
<div class="line">    Packets: Sent = 3, Received = 3, Lost = 0 (0% loss),</div>
<div class="line">Approximate round trip times in milli-seconds:</div>
<div class="line">    Minimum = 274ms, Maximum = 396ms, Average = 354ms</div>
<div class="line"> </div>
<div class="line">&lt;Terminal logs &gt;</div>
<div class="line">Network Stack Suspended, MCU will enter Deep sleep power mode.</div>
</div><!-- fragment --> <div class="image">
<img src="ICMP_wireshark.JPG" alt="" height="250px"/>
</div>
</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_ndoe"></a>
Neighbor Discovery offload</h2>
<p >Neighbor Discovery (ND), is a network protocol used with Internet Protocol Version 6 (IPv6). Neighbor discovery protocol allows different nodes on the same link to advertise their existence to their neighbors, and to learn about the existence of their neighbors. IPv6 implements Neighbor Solicitation and Neighbor Advertisement to determine/advertise the link layer address of a node (similar to ARP in IPv4).</p>
<p ><b>Neighbor Solicitation (NS):</b> Sent by a node to determine the link-layer address of a neighbor, or to verify that a neighbor is still reachable via a cached link-layer address. Neighbor Solicitations are also used for Duplicate Address Detection.</p>
<p ><b>Neighbor Advertisement (NA):</b> This is a response to Neighbor Solicitation which provides MAC address of the node for matching IPv6 link local address. Neighbor Advertisement also sent unsolicited to announce a IPv6 link local address change.</p>
<p >When device is in wake state, Neighbor Solicitation is received by network stack and the stack will respond with Neighbor Advertisement.</p>
<p >With Neighbor Discovery offload, WLAN firmware will respond to the Neighbor solicitation request by sendig Neighbor Advertisement packet to the peer without waking up the host processor allowing the host to stay is sleep state for longer duration. </p><div class="image">
<img src="NDOE_Offload.JPG" alt="" height="350px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_ndoe_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to use the Neighbor Discovery offload feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p >Neighbor Discovery offload is supported on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA, CYW955913EVK-01 and KIT_PSE84_EVAL_EPC2 devices.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Open design.modus file and do the following configuration settings in the ModusToolbox&trade; Device Configurator.<ul>
<li>switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Select Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Save the configuration to generate the necessary code.</li>
<li>Neighbor Discovery offload is enabled by default in the WLAN firmware. Hence user is not required to do any configuration settings in ModusToolbox&trade; Device Configurator.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Execute following command to build and program the application. <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application executes, the console output shows that it connected to the specified Wi-Fi AP, network stack is suspended and PSoC&trade; 6 MCU and WLAN goes to low power mode. As part of this offloads will be enabled. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Send a "ndisc6" command to the board from peer linux machine and observe MCU does not wake up. <div class="fragment"><div class="line">[root@cy-blr-au115]# ndisc6 fe80::0290:4cff:fec5:1238 wlan0</div>
<div class="line">Soliciting fe80::290:4cff:fe30:1001 (fe80::290:4cff:fe30:1001) on wlan0...</div>
<div class="line">Target link-layer address: 00:90:4C:30:10:01</div>
<div class="line">from fe80::290:4cff:fe30:1001</div>
</div><!-- fragment --></li>
<li>Verify in wireshark the Neighbor Discovery response is sent from WLAN firmware without waking up the host.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_null_keepalive"></a>
NULL Keepalive offload</h2>
<p >NULL keep-alive is a mechanism to maintain the wireless association/connection in idle state. NULL keepalive packets are 802.11/L2 packets which are sent at regular intervals in order to maintain the wireless association/connection.</p>
<p >With NULL keep-alive offload, WLAN FW sends the NULL keep alive packets periodically at the user configured intervals. By default NULL keepalive is configured to 110seconds in the WLAN fimrware. User can configure the intervals in Device Configurator. Interval value need to be in 1-4200 seconds range.</p>
<div class="image">
<img src="NULLKA.JPG" alt="" height="350px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_null_keepalive_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the NULL keepalive offload feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p >NULL keep-alive offload is supported only on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA and CYW955913EVK-01 devices.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Open design.modus file and do the following configuration settings in the ModusToolbox&trade; Device Configurator.<ul>
<li>switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Select Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Configure NULL keepalive "Interval" in seconds (default is 110seconds).</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Execute following command to build and program the application. <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application executes, the console output shows that it connected to the specified Wi-Fi AP, network stack is suspended and PSoC&trade; 6 MCU and WLAN goes to low power mode. As part of this offloads will be enabled. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Verify in wireshark the NULL keepalive is sent periodically from WLAN firmware for the configured intervals.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_nat_keepalive"></a>
NAT Keepalive offload</h2>
<p >NAT Keepalive maintains the NAT tables in the routers by periodically sending tiny UDP packets between the client and server. The Keep alive packets will ensure that the NAT Table of the intermediate router are updated and hence the packet forwarding happens smoothly without which there is high chance of dropping packets due to idle timeouts. NAT keepalive offload is active both in host sleep and host wake states.</p>
<p >With NAT keep-alive offload, WLAN FW sends keep alive packets periodically for configured interval.</p>
<div class="image">
<img src="NATKA.JPG" alt="" height="350px"/>
</div>
<h3><a class="anchor" id="group_lpa_p2_nat_keepalive_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the NAT keepalive offload feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p >NAT keep-alive offload is supported on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA and CYW955913EVK-01 devices.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Open design.modus file and do the following configuration settings in the ModusToolbox&trade; Device Configurator.<ul>
<li>switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Select Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable NAT keepalive.</li>
<li>Configure NAT keepalive "Interval" in seconds (default 60 seconds).</li>
<li>Configure "Source UDP port number" (default 49152).</li>
<li>Configure "Destination UDP port number" (default 50007).</li>
<li>Configure "Destination IP Address".</li>
<li>Configure Keep Alive data payload.</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Build the project and program the board. The following command is an example for the CY8CEVAL-062S2-CYW43022CUB board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application executes, the console output shows that it connected to the specified Wi-Fi AP, network stack is suspended and PSoC&trade; 6 MCU and WLAN goes to low power mode. As part of this offloads will be enabled. <div class="fragment"><div class="line">=======================================================</div>
<div class="line">CE230106 - Example: WLAN Lowpower</div>
<div class="line">=======================================================</div>
<div class="line"> </div>
<div class="line">WLAN MAC Address : D4:4D:A4:A0:02:A4</div>
<div class="line">WLAN Firmware    : wl0: Jan 27 2020 21:57:29 version 13.10.271.236 (5a526db) FWID 01-61e2b002</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2020-01-27 21:54:33</div>
<div class="line">WHD VERSION      : v1.80.0 : v1.80.0 : GCC 7.2 : 2020-03-10 04:09:17 -0500</div>
<div class="line">Info:Connecting to AP</div>
<div class="line">IP Address 10.0.0.201 assigned</div>
<div class="line">Info:Successfully joined Wi-Fi network <span class="stringliteral">&#39;SSID&#39;</span>.</div>
<div class="line">Info:Beacon period = 100, DTIM period = 3</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
<div class="line">Resuming Network Stack, Network stack was suspended <span class="keywordflow">for</span> 15253ms</div>
<div class="line"> </div>
<div class="line">=====================================================</div>
<div class="line">WHD Stats..</div>
<div class="line">tx_total:64, rx_total:71, tx_no_mem:0, rx_no_mem:0</div>
<div class="line">tx_fail:0, no_credit:0, flow_control:0</div>
<div class="line">Bus Stats..</div>
<div class="line">cmd52:2286, cmd53_read:366, cmd53_write:559</div>
<div class="line">cmd52_fail:0, cmd53_read_fail:0, cmd53_write_fail:0</div>
<div class="line">oob_intrs:72, sdio_intrs:147, error_intrs:0, read_aborts:0</div>
<div class="line">=====================================================</div>
<div class="line">Network is active. Resuming network stack</div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Verify in wireshark the NAT keepalive is sent periodically from WLAN firmware for the configured intervals. i.e. this will be send in both sleep state and wake state.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_wowlpf"></a>
Wake on WirelessLAN</h2>
<p >Wake on wireless LAN(WOWL) as the name suggests allows a host to be turned on or awakened when a WLAN FW receives a special network message from the AP. It is enabled in the case where host is in sleep state. The intention of wowl is to allow the host to go to sleep mode and device wakes it up on a specific packet is received.</p>
<p >Wake on Magic pattern: Wake on Magic Packet causes the WLAN to wake-up the host when it receives a magic packet. The magic packet is a broadcast packet that contains payload of 6 bytes of all 255 (FF FF FF FF FF FF in hexadecimal), followed by sixteen repetitions of the target 48-bit MAC address. With magic pattern configured, when WLAN firmware recevies network packet, it checks if it is a magic packet. If it is a magic packet, WLAN firmware will wake up the host.</p>
<p >Wake on net pattern: Wake on net pattern wake up the host when the packet recevied in the WLAN matches with the net pattern, mask and offset configured by the user.</p>
<p >Wake on pattern configuration puts the host to sleep state for longer duration without waking up for any incoming packets.</p>
<dl class="section note"><dt>Note</dt><dd>WOWL is supported only on non secure mode.</dd></dl>
<h3><a class="anchor" id="group_lpa_p2_wowlpf_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the WOWLPF feature in the FreeRTOS environment and its impact on the system power consumption.</p>
<p >WOWLPF offload is supported on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA and CYW955913EVK-01 devices.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_Low_Power present in ModusToolbox&trade; environment.</li>
<li>Open design.modus file and do the following configuration settings in the ModusToolbox&trade; Device Configurator.<ul>
<li>switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Select Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable WakeOnWireless LAN(WOWL) feature.</li>
<li>Configure "enable/disable" wake on magic pattern.</li>
<li>Configure "enable/disable" wake on net pattern.</li>
<li>Configure "net pattern". String should be in hex format and maximum size supported is 128 bytes.</li>
<li>Configure "Mask". Each bit in the mask represents one byte in the pattern. maximum size supported is 16 bytes.</li>
<li>Configure "Offset". Indicates offset from the beginging of the ethernet header, comparision of the net pattern starts from this offset.</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile if not present: FREERTOS, LWIP, and MBEDTLS. <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS WCM SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Build the project and program the board. The following command is an example for the CY8CEVAL-062S2-CYW43022CUB board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>Following is the example for pattern, offset and mask <div class="fragment"><div class="line">Pattern: 0x0123456789ABCDEF0123</div>
<div class="line">Offset: 2</div>
<div class="line">Mask:   0  0  1  0  1  0   0   1  1  0  0  0      (<span class="keywordflow">if</span> mask is 0x0298 (=0b0000001010011000) )</div>
<div class="line">then the pattern used in matching is 0xxxxx45xx89xxxxEF01xx (Where xx is don<span class="stringliteral">&#39;t care)</span></div>
</div><!-- fragment --></li>
<li>Send the ethernet packet from the peer containing the pattern.</li>
<li>Verify MCU wakes-up for the configured pattern.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_mqtt_keepalive"></a>
MQTT keepalive offload</h2>
<p >MQTT keepalive offload is part of the LPA and is designed to improve the power consumption of the connected system by reducing the time the host needs to stay awake to support MQTT keepalive request. This document describes how to enable MQTT keepalive offload and configure wakeup pattern for MQTT keepalive that can be incorporated into the project from <a href="https://github.com/Infineon/lpa"><b>Infineon GitHub LPA Middleware</b></a>.</p>
<p >MQTT keepalive maintains idle MQTT connections by periodically passing packets between the client and server. If either the client or server does not respond to a packet, the connection is considered inactive and is terminated. This helps in pruning dead connections. Typically MQTT keepalives is negotiataed between client and server during the MQTT connection where MQTT client will inform the server about the keepalive interval. This means host MCU has to wake up periodically to send MQTT keepalive packet to maintain MQTT connection during idle state.</p>
<p >MQTT keepalive offload helps in moving this functionality to WLAN firmware so that host MCU does not need to wake up periodically to send MQTT keepalive packets and wait for the response from server. This functionality is offloaded only when host MCU goes to Sleep mode and network stack is suspended.</p>
<p >With MQTT keepalive offload, host can be woken up from sleep state only when WLAN FW receives an mqtt message containing pattern that is configured by user through personality settings.</p>
<div class="image">
<img src="MQTT_Keepalive_basic_graph.png" alt="" height="350px"/>
</div>
<p >MQTT keepalive offload supports cipher suites having CBC encryption and SHA1 hash function with TLS1.2 when connecting to MQTT broker. Examples for supported cipher suites are </p><div class="fragment"><div class="line">TLS1.2: TLS_RSA_WITH_AES_128_CBC_SHA</div>
<div class="line">        TLS_RSA_WITH_AES_256_CBC_SHA</div>
<div class="line">        TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA</div>
<div class="line">        TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA</div>
</div><!-- fragment --><p >MQTT keepalive offload supports cipher suites TLS_AES_128_GCM_SHA256 and TLS_AES_256_GCM_SHA384 with TLS1.3 when connecting to MQTT broker. </p><div class="fragment"><div class="line">TLS1.3: TLS_AES_128_GCM_SHA256</div>
<div class="line">        TLS_AES_256_GCM_SHA384</div>
</div><!-- fragment --><p ><b>Note1 : MQTT keepalive offload only supports secure MQTT connections.</b></p>
<p ><b>Note2 : MQTT keepalive offload with TLS1.3 is currently supported only for CY8CEVAL-062S2-CYW43022CUB and CYW955913EVK-01 devices.</b></p>
<h3><a class="anchor" id="group_lpa_p2_mqtt_keepalive_qsg"></a>
Quick start guide</h3>
<p >This quick start guide demonstrates how to configure and use the MQTT keepalive offload feature in the RTOS environment.</p>
<p >MQTT keep-alive offload is supported on CY8CEVAL-062S2-CYW43022CUB, CY8CEVAL-062S2-CYW955513SDM2WLIPA and CYW955913EVK-01 devices. Following are the steps for MQTT keep-alive offload testing on CYW43022CUB device.</p>
<p >Follow the below steps for application creation and offload verification on CY8CEVAL-062S2-CYW43022CUB:</p>
<ol type="1">
<li>Create existing Code Example WLAN_LOW_POWER present in ModusToolbox&trade; environment.</li>
<li>Open library manager and add MQTT middleware into this application.</li>
<li>Copy <a href="https://github.com/Infineon/mtb-example-wifi-mqtt-client/tree/master/configs"><b>configs</b></a> folder into the application.</li>
<li>To configure MQTT offload client configurations refer <a href="https://github.com/Infineon/mtb-example-wifi-mqtt-client/blob/master/README.md#operation"><b>readme</b></a>. Make sure keep-alive interval (MQTT_KEEP_ALIVE_SECONDS) in mqtt_client_config.h should be greater than 10 seconds.</li>
<li>Configure MQTT keepalive offload. The easiest way to configure MQTT keepalive offload is to use the ModusToolbox&trade; Device Configurator. <br  />
<ul>
<li>Refer section <a class="el" href="index.html#group_lpa_p2_cc_hostwake">Wi-Fi host wake configuration</a> to verify WLAN_HOST_WAKE pin configurations using the Device Configurator.</li>
<li>In design.modus, switch to the connectivity device "CYW43022CUB" tab.</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane, enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Enable "MQTT Offload Configuration".</li>
<li>Configure "MQTT wake pattern" if user needs device to wake up for specific wake pattern. Else, MCU will wake up for any packet targetted to this device.<ul>
<li>MQTT wake pattern should be of the following format: <div class="fragment"><div class="line">&lt;topic_name&gt;&lt;message&gt;</div>
</div><!-- fragment --> Eg: topic="ledstatus" and message="TURN_ON". Wake pattern to be set to ensure that device wakes on only this particular pattern is "ledstatusTURN_ON" <div class="image">
<img src="mqtt_offload_configurator.png" alt=""/>
</div>
</li>
</ul>
</li>
<li>Save the configuration to generate the necessary code.</li>
</ul>
</li>
<li>In the application, subscribe for the topic which is used to publish the wake pattern from the server.</li>
<li>Intergate LPA API's needed for MQTT offload into the application. Refer <a class="el" href="index.html#subsection_lpa_snippet_7">Code Snippet 7: MQTT offload configuration.</a> which proivdes information about the APIs to be called from application.</li>
<li><p class="startli">lwIP + Mbedtls : The following are the prerequisite when using lwip + mbedtls combination.</p>
<p class="startli">8.1. Comment the below macro to enable support for key export in mbedtls_user_config.h </p><div class="fragment"><div class="line"><span class="preprocessor">#undef MBEDTLS_SSL_EXPORT_KEYS</span></div>
</div><!-- fragment --><p> 8.2. TLS1.2: Make sure SHA1 is enabled in security stack configuration and the cipher-suite negotiated with the broker is one of the offload supported cipher-suite. </p><div class="fragment"><div class="line"><span class="preprocessor">#define MBEDTLS_SSL_CIPHERSUITES  MBEDTLS_TLS_RSA_WITH_AES_128_CBC_SHA, MBEDTLS_TLS_RSA_WITH_AES_256_CBC_SHA</span></div>
</div><!-- fragment --><p> 8.3. TLS1.3: TLS1.3 cipher suites shall be enabled in mbedtls_user_config.h. </p><div class="fragment"><div class="line"><span class="preprocessor">#define MBEDTLS_SSL_CIPHERSUITES  MBEDTLS_TLS1_3_AES_128_GCM_SHA256, MBEDTLS_TLS1_3_AES_256_GCM_SHA384</span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>PSOC&trade; Edge E84 Evaluation Kit supports MQTT connections using TLS1.3, but its MQTT offload feature is limited to TLS1.2, requiring the user to disable TLS1.3. To use MQTT offload, disable TLS1.3 by undefining the "MBEDTLS_SSL_PROTO_TLS1_3" parameter to ensure compatibility.</dd></dl>
</li>
<li>NetXDuo + NetXSecure :<ul>
<li>By default SHA1 cipher suites are disabled. To enable MQTT keepalive offload supported cipher suites, add 'CY_TLS_DEFAULT_ALLOW_SHA1_CIPHER' application's Makefile defines. The Makefile entry should look like as follows: <div class="fragment"><div class="line">DEFINES+=CY_TLS_DEFAULT_ALLOW_SHA1_CIPHER</div>
</div><!-- fragment --></li>
<li>Copy <code>cy_tls_ciphersuites.h</code> from secure-sockets to application folder and ensure that only these cipher suite entries are present in tlsv12 and tlsv13 lookup tables. This will ensure that the device will negotitate the offload supported cipher suite with the broker.</li>
</ul>
</li>
<li>Add the following to COMPONENTS in the application Makefile. When using FREERTOS, LWIP, and MBEDTLS combination <div class="fragment"><div class="line">COMPONENTS = FREERTOS LWIP MBEDTLS SECURE_SOCKETS</div>
</div><!-- fragment --> When using THREADX, NETXDUO, and NETXSECURE combination <div class="fragment"><div class="line">COMPONENTS = THREADX NETXDUO NETXSECURE SECURE_SOCKETS</div>
</div><!-- fragment --></li>
<li>Build the project and program the board. The following command is an example for the CY8CEVAL-062S2-CYW43022CUB board, using GCC_ARM as the toolchain: <div class="fragment"><div class="line">make build TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
<div class="line">make program TARGET=CY8CEVAL-062S2-CYW43022CUB TOOLCHAIN=GCC_ARM</div>
</div><!-- fragment --></li>
<li>When the application executes, the console output shows that it connected to the specified Wi-Fi AP, MQTT connection successful and network stack is suspended. As part of this MQTT offload will be enabled. <div class="fragment"><div class="line">===============================================================</div>
<div class="line">CE229889 - AnyCloud Example: MQTT Client KEEPALIVE OFFLOAD</div>
<div class="line">===============================================================</div>
<div class="line"> </div>
<div class="line">[F4] : [L1] : 0000 00:00:00.000 WCM initialize start</div>
<div class="line">WLAN MAC Address : 00:A0:50:1A:67:7B</div>
<div class="line">WLAN Firmware    : wl0: Mar  8 2024 08:27:54 version 13.34.107.95 (517c45b CY) FWID 01-afc9a52b</div>
<div class="line">WLAN CLM         : API: 18.2 Data: 9.10.0 Compiler: 1.36.1 ClmImport: 1.34.1 Creation: 2023-07-11 05:46:05</div>
<div class="line">WHD VERSION      : 3.1.0.23156 : v3.1.0 : GCC 11.3 : 2024-03-12 17:03:16 +0800</div>
<div class="line">whd_tko_toggle: Successfully enabled</div>
<div class="line">[F4] : [L1] : 0001 00:00:01.639 WCM initialize end</div>
<div class="line">GNER6: Entered wifi_connect</div>
<div class="line">[F0] : [L1] : 0002 00:00:01.639</div>
<div class="line">Connecting to Wi-Fi AP <span class="stringliteral">&#39;dd-wrt&#39;</span></div>
<div class="line"> </div>
<div class="line">[F0] : [L1] : 0003 00:00:06.292</div>
<div class="line">Successfully connected to Wi-Fi network <span class="stringliteral">&#39;dd-wrt&#39;</span>.</div>
<div class="line">IPv4 Address Assigned: 192.168.1.107</div>
<div class="line"> </div>
<div class="line">MQTT library initialization successful.</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">cy_mqtt_register_event_callback --------------------------- Pass</div>
<div class="line"> </div>
<div class="line">MQTT client <span class="stringliteral">&#39;psoc6-mqtt-client&#39;</span> connecting to MQTT broker <span class="stringliteral">&#39;192.168.1.116&#39;</span>...</div>
<div class="line">MQTT connection successful.</div>
<div class="line"> </div>
<div class="line">MQTT client subscribed to the topic <span class="stringliteral">&#39;/topic/mqtt_server&#39;</span> successfully.</div>
<div class="line">create sub task Q 0x802d058</div>
<div class="line"> </div>
<div class="line">Subsciber: Incoming MQTT message received:</div>
<div class="line">    Publish topic name: /topic/mqtt_server</div>
<div class="line">    Publish QoS: 0</div>
<div class="line">    Publish payload: mqtt_offload</div>
<div class="line">network_idle_func   timeout 0 8005f60 8005f60</div>
<div class="line">network stack suspend notify callback. notify_type:0</div>
<div class="line"> </div>
<div class="line">Network Stack Suspended, MCU can enter DeepSleep power mode</div>
</div><!-- fragment --></li>
<li>Verify in Wireshark that TLS Keepalive request is send from the device periodically and Keepalive response is received from the server.</li>
</ol>
<h2><a class="anchor" id="group_lpa_p2_cc"></a>
Wi-Fi low power configuration considerations</h2>
<p >Refer to the section <a class="el" href="index.html#group_device_configurator_flow">ModusToolbox&trade; Device Configurator flow</a> to configure MCU low power using desgin.modus To open the ModusToolbox&trade; Device Configurator, right-click on the project in the Project Explorer pane in the ModusToolbox&trade; IDE, and select ModusToolbox&trade; Configurators &gt; Device Configurator.</p>
<ol type="1">
<li>Select the Wi-Fi radio device tab (e.g., CYW4343WKUBG).</li>
<li>Enable the Wi-Fi personality and go to the Wi-Fi Parameters pane to configure the LPA middleware.</li>
<li>Set Host Wake Configuration. Enable and assign the Host Device Interrupt Pin. Refer to the kit datasheet to find out which pin is routed on board PCB.</li>
<li>Set ARP Offload. Enable and configure the LPA with the desired parameters.</li>
<li>Set AWS MQTT Filters. Enable MQTT TLS Filter to enable corresponding filter.</li>
<li>Configure MQTT TLS Filter Configuration parameters with desired values.</li>
<li>Set Packet Filters. Enable Filter Configuration &lt;N&gt; to get access to the filter parameters.</li>
<li>Configure the enabled filter on the previous step with desired parameters.</li>
<li>Perform File-&gt;Save to generate initialization code.</li>
</ol>
<div class="image">
<img src="WIFI_Personality.png" alt=""/>
</div>
<p >For CY8CEVAL-062S2-CYW43022CUB device, do below additional changes.</p>
<ol type="1">
<li>Select the Wi-Fi radio device tab (e.g., CYW43022CUB).</li>
<li>ULP support is enabled by default. Set the wait time.</li>
<li>Perform File-&gt;Save to generate initialization code.</li>
</ol>
<div class="image">
<img src="ULP_Personality.png" alt=""/>
</div>
<p >After saving the configuration file, the generated code is available under the GeneratedSource folder, located next to the design.modus file in the BSP:</p><ul>
<li>C Data File: /GeneratedSource/cycfg_connectivity_wifi.c</li>
<li>C Header File: /GeneratedSource/cycfg_connectivity_wifi.h</li>
</ul>
<h3><a class="anchor" id="group_lpa_p2_cc_hostwake"></a>
Wi-Fi host wake configuration</h3>
<p >This section explains how to enable the Wi-Fi host wake configuration using the Device Configurator tool. <br  />
 <br  />
 By Default, WLAN host wake is configured properly and below device configurator support allows user to modify it to different GPIOs. The correct pins won’t show up in the list unless that pin is enabled from the Pins tab. If user selects <b><em>Host Wake Configuration Enable</em></b> checkbox and does not select any pin for <b><em>Host Device Interrupt Pin</em></b>, System will Hang and this should be avoided by the user</p>
<div class="image">
<img src="hostwake_MTConfigure.png" alt="" height="150px"/>
</div>
<p >The following table lists the Device name and its corresponding Wi-Fi wost wake pin. </p><table class="doxtable">
<tr>
<th>Infineon platform </th><th>Wi-Fi Host wake pin  </th></tr>
<tr>
<td align="center">CY8CKIT_062_WIFI_BT </td><td align="center">P2[7]  </td></tr>
<tr>
<td align="center">CY8CKIT_062S2_43012 </td><td align="center">P4[1]  </td></tr>
<tr>
<td align="center">CY8CEVAL-062S2-CYW43022CUB </td><td align="center">P4[1]  </td></tr>
<tr>
<td align="center">CY8CEVAL-062S2-CYW955513SDM2WLIPA </td><td align="center">P4[1]  </td></tr>
<tr>
<td align="center">CY8CPROTO_062_4343W </td><td align="center">P0[4]  </td></tr>
<tr>
<td align="center">CY8CEVAL_062S2_LAI_4373M2 </td><td align="center">P4[1]  </td></tr>
<tr>
<td align="center">CY8CEVAL_062S2_MUR_43439M2 </td><td align="center">P4[1]  </td></tr>
<tr>
<td align="center">CYW955913EVK-01 </td><td align="center">Wi-Fi Subsystem Doorbell Wake Interrupt(Enabled by default)  </td></tr>
</table>
<p><br  />
 The following is an example of the CY8CKIT_062S2_43012 device to how to enable the Wi-Fi host wake configuration:</p>
<h3><a class="anchor" id="group_lpa_p2_cc_CY8CKIT_062S2_43012"></a>
CY8CKIT_062S2_43012</h3>
<ul>
<li>On the PSoC&trade; 6 MCU Pins tab of the Device Configurator tool , Enable the Host wake pin P4[1] and name it CYBSP_WIFI_HOST_WAKE.</li>
<li>In the Parameters pane, change the following:<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: High(1).</li>
<li>Interrupt Trigger Type: Rising Edge.</li>
</ul>
</li>
<li>Go to WiFi tab, set Host Device Interrupt Pin to CYBSP_WIFI_HOST_WAKE.</li>
</ul>
<div class="image">
<img src="hostwake_config_43012_062S2_kit.png" alt="" height="400px"/>
</div>
<dl class="section note"><dt>Note</dt><dd>For CYW955913EVK-01, host wake pin configuration does not apply as the Doorbell wake interrupt is enabled by default. </dd>
<dd>
For CY8CEVAL-062S2-CYW955513SDM2WLIPA, <b><em>Drive Mode</em></b> should be set to <b><em>Resistive Pull UP, Input Buffer ON</em></b></dd></dl>
<h3><a class="anchor" id="group_lpa_p2_cc_limitations"></a>
Limitations</h3>
<ol type="1">
<li>The maximum number of filters is ultimately dictated by free memory on the Wi-Fi chipset. More memory will allow more filters. Different Wi-Fi chips running FW from different branches will likely have slightly different maximum numbers of filters. It is possible to add 20 filters on a CY8CKIT_062S2_43012 kit without any issue.</li>
<li>Network stack suspend/resume functionality, which is called in the main.c function, enables the host MCU to remain in Deep Sleep for longer durations (wake up only for external events). (Maximum sleep-time possible is 36 hours (1.5 days). This means the host MCU will wake up without an interrupt from an external event after 36 hours and then immediately go back to sleep. This has a very low power impact.</li>
</ol>
<h3><a class="anchor" id="group_lpa_p2_ipv6_filter"></a>
IPv6 Packet Filter for MCU Deep Sleep</h3>
<ul>
<li>MCU will wake for IPv6 packets intermittently, So add packet filter for IPv6 packets to avoid unnecessary wakeup. <br  />
 How to configure packet Filter for IPv6 packets: <br  />
<ul>
<li>Navigate to ModusToolbox&trade; installation folder and launch the ModusToolbox&trade; Device Configurator (&lt;install_dir&gt;/tools_3.2/device-configurator).</li>
<li>Select File-&gt;Open, navigate to the board's design.modus file, and open it:</li>
<li>Switch to the connectivity device "CYW943012WKWBG" tab (in case the CY8CKIT_062S2_43012 board is used).</li>
<li>Enable Power-&gt;Wi-Fi.</li>
<li>In "Wi-Fi - Parameters" pane enable "Host Wake Configuration" and set "Host Device Interrupt Pin" to "CYBSP_WIFI_HOST_WAKE".</li>
<li>Select Enable Packet Filter Configuration 0</li>
<li>Select Filter Type as "Ether Type"</li>
<li>Select Action as "Discard"</li>
<li>Configure Ethertype as "0x86dd"</li>
<li>Save the configuration to generate the necessary code</li>
</ul>
</li>
</ul>
<h3><a class="anchor" id="group_lpa_p2_wlan_lowpower"></a>
WLAN low power configuration</h3>
<p >The WLAN firmware supports two different low-power modes: (legacy) 802.11 PS-Poll mode and high throughput powersave mode. Refer to <a href="https://Infineon.github.io/wifi-host-driver/API/group__wifipowersave.html"><b> WLAN Powersave API </b></a></p>
<p >These can be configured using the following Wi-Fi host driver APIs: <br  />
</p><ol type="1">
<li><b> 802.11 PS-Poll mode </b> <div class="fragment"><div class="line"><span class="comment">// ifp : Pointer to WHD Interface</span></div>
<div class="line"> </div>
<div class="line">whd_wifi_enable_powersave(ifp);</div>
</div><!-- fragment --></li>
<li><b> High Throughout Powersave mode </b> <div class="fragment"><div class="line"><span class="comment">// This macro specifies the duration in milliseconds for which the STA stays</span></div>
<div class="line"><span class="comment">// awake after receiving frames from AP in PM2 mode. The delay value must be set</span></div>
<div class="line"><span class="comment">// to a multiple of 10 and not equal to zero. Minimum value is 10u. Maximum</span></div>
<div class="line"><span class="comment">// value is 2000u.</span></div>
<div class="line"><span class="comment">// ifp : Pointer to WHD Interface</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define RETURN_TO_SLEEP_MS                (10u)</span></div>
<div class="line"> </div>
<div class="line">whd_wifi_enable_powersave_with_throughput(ifp, RETURN_TO_SLEEP_MS);</div>
</div><!-- fragment --></li>
</ol>
<h3><a class="anchor" id="group_lpa_p2_cc_parameters"></a>
Configuration parameters</h3>
<p >The following parameters and their mapping to macros are available:</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Parameter </th><th>Description </th><th>Parameter values </th></tr>
<tr>
<td>Host Wake Configuration </td><td>Host Device Interrupt Pin </td><td>Selects the host pin which is connected to Wi-Fi device's HOST WAKE signal. </td><td><ul>
<li>Empty (default)</li>
<li>Any enabled pin from Pin tab </li>
</ul>
</td></tr>
<tr>
<td>Host Wake Configuration </td><td>Wi-Fi Device Interrupt Pin </td><td>Wi-Fi device GPIO_0 is reserved as device wake-up interrupt request pin (WL HOST WAKE). </td><td><ul>
<li>Read Only </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>ARP Offload When Host Awake </td><td>Respond to ARP Requests when Awake. </td><td><ul>
<li>Disabled (default)</li>
<li>Host Auto Reply</li>
<li>Peer Auto Reply</li>
<li>Host and Peer Auto Reply </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>ARP Offload When Host Sleeping </td><td>Respond to ARP Requests when Sleeping. </td><td><ul>
<li>Disabled (default)</li>
<li>Peer Auto Reply </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>Snoop Host IP from traffic when ARP Offload enabled </td><td>The host IP address is snooped from an ARP Request. If disabled, the WLAN Device will need to be informed of the Host IP address when the network interface is configured (statically or dynamically via DHCP). </td><td><ul>
<li>Off (default)</li>
<li>On </li>
</ul>
</td></tr>
<tr>
<td>ARP Offload </td><td>ARP Offload Cache entries expire after (s) </td><td>When the ARP cache table is offloaded from the host to the device, table entries are subject to an aging value called "peer age". </td><td><ul>
<li>1200 (default)</li>
<li>1-4294967295 </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Filter ID </td><td>Filter ID </td><td><ul>
<li>0 (for MQTT Filter)</li>
<li>1 (for MQTT TLS Filter) </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Action </td><td>Filter can either pass up packets that match the filter to the host (Keep) or drop them so the host never gets them (Discard). </td><td><ul>
<li>Keep (default)</li>
<li>Discard </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>When Active </td><td>Defines when the filter is active, when the host is awake, when it goes to sleep, or both. </td><td><ul>
<li>Sleep (default)</li>
<li>Wake</li>
<li>Always </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Protocol </td><td>Choose communication protocol. </td><td><ul>
<li>TCP (default)</li>
<li>UDP </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Direction </td><td>Inbound - destination port, outbound - source port. </td><td><ul>
<li>Destination Port (default)</li>
<li>Source Port</li>
<li>Destination and Source Port </li>
</ul>
</td></tr>
<tr>
<td>MQTT Filter Configuration </td><td>Port Number </td><td>Either the single port to be filtered or the beginning of the block of contiguous numbers. When using a block, the starting port must be power of 2. </td><td><ul>
<li>8883 for TLS</li>
<li>1883 for Non TLS </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Filter ID </td><td>Filter ID </td><td><ul>
<li>0-21 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Filter Type </td><td>Each port filter can specify either a single port or a block of port numbers.<ul>
<li>Port Filter on a 16 bit UDP or TCP port number. Refer to <a class="el" href="index.html#group_lpa_p2_filtertypes">Filter types</a> for details of port numbers.</li>
<li>Port Block Filter of port numbers (vs a single port). Envisioned to be used by short lived ephemeral ports on source port.</li>
<li>Ether Type accepts a 16 bit ethertype value to filter on. Refer to the <a class="el" href="index.html#group_lpa_p2_filtertypes">Filter types</a> section (EtherTypes). Common values are 0x800 (IP) and 0x806 (ARP).</li>
<li>IP Type accepts an 8 bit IP Protocol number to filter on. Refer to the <a class="el" href="index.html#group_lpa_p2_filtertypes">Filter types</a> section (IPProtocols). </li>
</ul>
</td><td><ul>
<li>Port Filter</li>
<li>Port Block Filter</li>
<li>Ether Type</li>
<li>IP Type </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Action </td><td>Filter can either pass up packets that match the filter to the host (Keep) or drop them so the host never gets them (Discard). </td><td><ul>
<li>Keep (default)</li>
<li>Discard </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>When Active </td><td>Defines when the filter is active, when the host is awake, when it goes to sleep, or both. </td><td><ul>
<li>Sleep (default)</li>
<li>Wake</li>
<li>Always </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Protocol </td><td>Chooses communication protocol. Filter can be constrained to either TCP or UDP. To match either TCP or UDP use two filters, one for each. </td><td><ul>
<li>TCP (default)</li>
<li>UDP </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Direction </td><td>Inbound - destination port, outbound - source port. Packets have both a source and destination port. This specifies which one to use. A single port usually uses the destination port. </td><td><ul>
<li>Destination Port (default)</li>
<li>Source Port </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Port Number </td><td>Either the single port to be filtered or the beginning of the block of contiguous numbers. When using a block, the starting port must be a power of 2. </td><td><ul>
<li>1024 for Packet filter (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Range </td><td>Indicates the size of the block of port numbers, must be of the form (2^y - 1) and less than Port Number (Filter Type = Port Filter Block). 0 indicates just a single port. </td><td><ul>
<li>1023 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>Ether Type </td><td>Enter EtherType value for desired protocol (Filter Type = Ether Type). </td><td><ul>
<li>0 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>Packet Filter Configuration &lt;N&gt; </td><td>IP protocol </td><td>Enter desired IP protocol number (Filter Type = IP Type). </td><td><ul>
<li>0 (default)</li>
<li>0-255 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Interval </td><td>Enter desired Keepalive Request interval in seconds </td><td><ul>
<li>20 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Retry Interval </td><td>Keepalive retry interval in seconds if Keepalive ack is not received </td><td><ul>
<li>3 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Retry Count </td><td>Retry count in seconds if Keepalive ack is not received </td><td><ul>
<li>3 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Source port </td><td>TCP Keepalive Source port number </td><td><ul>
<li>0 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Destination port </td><td>TCP Keepalive Destination port number </td><td><ul>
<li>0 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>TCP Keepalive Offload Configuration &lt;N&gt; </td><td>Destination IP address </td><td>TCP Keepalive Destination IP address  </td><td><ul>
<li>0.0.0.0 (default) </li>
</ul>
</td></tr>
<tr>
<td>NULL Keepalive Offload Configuration </td><td>Interval </td><td>NULL Keepalive periodic interval in seconds  </td><td><ul>
<li>110 (default) </li>
</ul>
</td></tr>
<tr>
<td>NAT Keepalive Offload Configuration </td><td>Interval </td><td>NAT Keepalive periodic interval in seconds  </td><td><ul>
<li>60 (default) </li>
</ul>
</td></tr>
<tr>
<td>NAT Keepalive Offload Configuration </td><td>Source port </td><td>NAT Keepalive Source port number </td><td><ul>
<li>49152 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>NAT Keepalive Offload Configuration </td><td>Destination port </td><td>NAT Keepalive Destination port number </td><td><ul>
<li>50007 (default)</li>
<li>0-65535 </li>
</ul>
</td></tr>
<tr>
<td>NAT Keepalive Offload Configuration </td><td>Destination IP address </td><td>NAT Keepalive Destination IP address  </td><td><ul>
<li>0.0.0.0 (default) </li>
</ul>
</td></tr>
<tr>
<td>NAT Keepalive Offload Configuration </td><td>Keep Alive Payload </td><td>NAT Keepalive Payload  </td><td><ul>
<li>0 (default) </li>
</ul>
</td></tr>
<tr>
<td>WakeOnWireless LAN(WOWL) Configuration </td><td>Magic Pattern </td><td>WOWL enable wake on magic pattern </td><td></td></tr>
<tr>
<td>WakeOnWireless LAN(WOWL) Configuration </td><td>pattern </td><td>WOWL net pattern string </td><td>empty (default)  </td></tr>
<tr>
<td>WakeOnWireless LAN(WOWL) Configuration </td><td>mask </td><td>WOWL net pattern mask </td><td>empty (default)  </td></tr>
<tr>
<td>WakeOnWireless LAN(WOWL) Configuration </td><td>offset </td><td>WOWL net pattern offset </td><td>0 </td></tr>
<tr>
<td>MQTT Offload Configuration </td><td>MQTT wake pattern </td><td>MQTT offload wake pattern string </td><td>empty (default)  </td></tr>
</table>
<h1><a class="anchor" id="group_lpa_p3"></a>
Part 3. Bluetooth® Low Power</h1>
<p >The Bluetooth low-power feature enables the host to achieve its lowest power consumption with enabled Bluetooth. The BT Low Power personality helps configure the pin connections between the MCU host and BT device. <br  />
 The LPA library provides configurations for MCU Low Power, Wi-Fi Low Power and Bluetooth® Low Power; however, the LPA library only needs to be included in applications that use Wi-Fi low power.</p>
<h2><a class="anchor" id="group_lpa_p3_cc"></a>
BT Low Power Configuration considerations</h2>
<p >Follow the below steps for BT Low Power Configuration considerations.</p><ol type="1">
<li>Refer to the section <a class="el" href="index.html#group_device_configurator_flow">ModusToolbox&trade; Device Configurator flow</a> to configure MCU low power using desgin.modus</li>
<li>Select Wi-Fi radio device tab (for example, CYW4343WKUBG).</li>
<li>Enable the Bluetooth&reg; resource and go to the Bluetooth&reg; Parameters pane to configure the LPA Middleware.</li>
<li>Enable Bluetooth&reg; Wake Configuration.</li>
<li>Choose a pin for Host-wake-up signal. Refer to the kit datasheet to find out which pin is routed on board PCB.</li>
<li>Choose a pin for Device-wake-up signal and Device-wake-up trigger interrupt type. Refer to the kit datasheet to find out which pin is routed on board PCB.</li>
<li>Select File-&gt;Save to generate initialization code. <br  />
 <b>Note:</b> If the pins for Host-wake-up signal and Device-wake-up signal are not unselected. The BSP uses the default pins with the standard names of CYBSP_BT_HOST_WAKE and CYBSP_BT_DEVICE_WAKE respectively. <br  />
 <div class="image">
<img src="BT_Personality.png" alt="" height="250px"/>
</div>
</li>
</ol>
<p >After saving the configuration file, the generated code is available under the GeneratedSource folder, located next to the design.modus file in the BSP:</p><ul>
<li>C Data File: /GeneratedSource/cycfg_connectivity_bt.c</li>
<li>C Header File: /GeneratedSource/cycfg_connectivity_bt.h</li>
</ul>
<h3><a class="anchor" id="group_lpa_p3_cc_btwakeconfig"></a>
BT Wake Configuration</h3>
<p >This section explains how to enable the Bluetooth&reg; wake configuration using the device configurator tool. <br  />
 <br  />
 The following table lists the device name and its corresponding Bluetooth&reg; host wake pin and Bluetooth&reg; device wake pin: </p><table class="doxtable">
<tr>
<th>Infineon platform </th><th>BT Host wake pin </th><th>BT Device wake pin  </th></tr>
<tr>
<td align="center">CY8CKIT_062_WIFI_BT </td><td align="center">P3[5] </td><td align="center">P4[0]  </td></tr>
<tr>
<td align="center">CY8CKIT_062S2_43012 </td><td align="center">P3[5] </td><td align="center">P4[0]  </td></tr>
<tr>
<td align="center">CY8CPROTO_062_4343W </td><td align="center">P3[5] </td><td align="center">P4[0]  </td></tr>
<tr>
<td align="center">CY8CEVAL_062S2_LAI_4373M2 </td><td align="center">P2[7] </td><td align="center">P4[0]  </td></tr>
<tr>
<td align="center">CY8CEVAL_062S2_MUR_43439M2 </td><td align="center">P3[5] </td><td align="center">P4[0]  </td></tr>
<tr>
<td align="center">CYW955913EVK-01 </td><td align="center">Bluetooth activity </td><td align="center">Bluetooth activity  </td></tr>
</table>
<p><br  />
 The following table lists the Device name and its corresponding Bluetooth&reg; host wake pin and Bluetooth&reg; device wake pin:</p>
<h3><a class="anchor" id="group_lpa_p3_cc_btwakeconfig_CY8CKIT_062S2_43012"></a>
CY8CKIT_062S2_43012</h3>
<ul>
<li>On the PSoC&trade; 6 MCU Pins tab of the Device Configurator tool<ul>
<li>Enable the Bluetooth&reg; device wake pin P3[5] and name it CYBSP_BT_DEVICE_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Strong Drive. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
<li>Enable the Bluetooth&reg; Host wake pin P4[0] and name it CYBSP_BT_HOST_WAKE.<ul>
<li>In the Parameters pane, change the following.<ul>
<li>Drive Mode: Analog High-Z. Input buffer off.</li>
<li>Initial Drive State: Low(0).</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>Go to Bluetooth&reg; tab in CYW43012C0WKWBG and change the following.<ul>
<li>Enable Bluetooth&reg; wake up configurations checkbox</li>
<li>Host Wake-Up Signal : CYBSP_BT_HOST_WAKE</li>
<li>Host Wake-Up IRQ event: Failing Edge</li>
<li>Device Wake-Up Signal : CYBSP_BT_DEVICE_WAKE</li>
<li>Device Wake-up Polarity : Active low</li>
</ul>
</li>
</ul>
<div class="image">
<img src="btwake_config_43012_062S2_kit.png" alt="" height="400px"/>
</div>
<h3><a class="anchor" id="group_lpa_p3_cc_parameters"></a>
Configuration parameters</h3>
<p >The following parameters and their mapping to macros are available:</p>
<table class="doxtable">
<tr>
<th>Category </th><th>Parameter </th><th>Description </th><th>Parameter values </th></tr>
<tr>
<td>Host Wake Configuration </td><td>Host-Wake-Up Signal </td><td>Select the host pin which is connected to BT device's BT_HOST_WAKE signal. </td><td><ul>
<li>Empty (default)</li>
<li>Any enabled pin from Pin tab </li>
</ul>
</td></tr>
<tr>
<td>Host Wake Configuration </td><td>Host-Wake-IRQ-Event </td><td>Select the Trigger for Host wake IRQ event. </td><td><ul>
<li>Falling Edge (Active Low) (default)</li>
<li>Rising Edge (Active High) </li>
</ul>
</td></tr>
<tr>
<td>BT Device Wake Configuration </td><td>Device-Wake-Up Signal </td><td>Select the host pin which is connected to BT device's BT_DEV_WAKE signal. </td><td><ul>
<li>Empty (default)</li>
<li>Any enabled pin from Pin tab </li>
</ul>
</td></tr>
<tr>
<td>BT Device Wake Configuration </td><td>Device-Wake-Up Polarity </td><td>Select the Polarity condition for BT_DEV_WAKE signal. </td><td><ul>
<li>Active Low (default)</li>
<li>Active High </li>
</ul>
</td></tr>
</table>
<h1><a class="anchor" id="section_lpa_measurement"></a>
How to measure power consumption</h1>
<p >For jumper connections and how to measure power consumption, refer to the guide of the respective kit. <br  />
 <b>For Example:</b></p>
<p >To measure the power consumption for the CY8CKIT-062S2-43012 Kit, refer to section <em>3.2.5 Power Supply System</em> in the kit guide <a href="https://www.infineon.com/dgdl/Infineon-CY8CKIT-062S2-43012_PSoC_62S2_Wi-Fi_BT_Pioneer_Kit_Guide-UserManual-v01_00-EN.pdf?fileId=8ac78c8c7d0d8da4017d0f01c8f11927"><b>User manual</b></a>.</p>
<p >To measure the power consumption for the CYW955913EVK-01 Kit, refer to section <em>Power measurement using CYW955913EVK-01</em> in the kit guide <a href="https://www.infineon.com/CYW55913"><b>User manual</b></a>.</p>
<h1><a class="anchor" id="group_lpa_misra"></a>
MISRA-C Compliance</h1>
<p >If you need a MISRA compliance report for this library, create a ticket at <a href="https://www.infineon.com/cms/en/about-infineon/company/contacts/support/"><b>Infineon support</b></a></p>
<h1><a class="anchor" id="group_lpa_errata"></a>
Errata</h1>
<p >This section lists the known problems with the LPA middleware.</p>
<h1><a class="anchor" id="section_lpa_more_information"></a>
More information</h1>
<p >For more information, Infineon highly recommends starting with these documents.</p>
<ul>
<li><a href="https://github.com/Infineon/lpa"><b>Infineon GitHub LPA Middleware</b></a></li>
<li><a href="https://www.infineon.com/cms/en/design-support/tools/sdk/modustoolbox-software/?redirId=178597"><b>ModusToolbox&trade; Software Environment, Quick Start Guide, Documentation, and Videos</b></a></li>
<li><a href="https://github.com/Infineon/mtb-example-wifi-wlan-lowpower"><b>LPA Middleware Code Example for FREERTOS </b></a></li>
<li><a href="https://github.com/Infineon"><b>LPA Middleware Code Examples at GITHUB</b></a></li>
<li><a href="https://www.infineon.com/dgdl/Infineon-ModusToolbox_Device_Configurator_4.0_User_Guide-UserManual-v01_00-EN.pdf?fileId=8ac78c8c8386267f0183a960bd41598f&amp;utm_source=cypress&amp;utm_medium=referral&amp;utm_campaign=202110_globe_en_all_integration-files&amp;redirId=180683&amp;redirId=VL144"><b>ModusToolbox&trade; Device Configurator Tool Guide</b></a></li>
<li><a href="https://www.infineon.com/dgdl/Infineon-PSoC_6_MCU_PSoC_63_with_BLE_Architecture_Technical_Reference_Manual-AdditionalTechnicalInformation-v11_00-EN.pdf?fileId=8ac78c8c7d0d8da4017d0f946fea01ca&amp;utm_source=cypress&amp;utm_medium=referral&amp;utm_campaign=202110_globe_en_all_integration-technical_reference_manual&amp;redirId=TRM148"><b>PSoC&trade; 6 Technical Reference Manual</b></a></li>
<li><a href="https://www.infineon.com/dgdl/Infineon-PSoC_6_MCU_PSoC_63_with_BLE_Datasheet_Programmable_System-on-Chip_(PSoC)-DataSheet-v16_00-EN.pdf?fileId=8ac78c8c7d0d8da4017d0ee4efe46c37&amp;utm_source=cypress&amp;utm_medium=referral&amp;utm_campaign=202110_globe_en_all_integration-datasheet&amp;redirId=VL4079"><b>PSoC&trade; 63 with BLE Datasheet Programmable System-on-Chip datasheet</b></a></li>
<li><a href="https://www.infineon.com"><b>Infineon</b></a></li>
</ul>
<p ><b>Note</b> Links to other software component's documentation (middleware and PDL) point to Infineon GitHub and the latest available version of the software. To get documentation for a specific version, download it from GitHub and unzip the component archive. The documentation is available in the docs folder.</p>
<h1><a class="anchor" id="section_lpa_code_snippets"></a>
Code Snippets</h1>
<h2><a class="anchor" id="subsection_lpa_snippet_1"></a>
Code Snippet 1: Using wait_net_suspend for suspend/resume network stack</h2>
<p >The following code snippet demonstrates an example for Suspending Network stack to allow MCU to go to Deep Sleep. LPA API <b>cylpa_on_emac_activity</b> should be called to resume network stack in order to queue packets to LwIP. </p><div class="fragment"><div class="line">    <span class="comment">/* Configures an emac activity callback to the Wi-Fi interface and</span></div>
<div class="line"><span class="comment">     * suspends the network if the network is inactive for a duration of</span></div>
<div class="line"><span class="comment">     * INACTIVE_WINDOW_MS inside an interval of INACTIVE_INTERVAL_MS. The</span></div>
<div class="line"><span class="comment">     * callback is used to signal the presence/absence of network activity</span></div>
<div class="line"><span class="comment">     * to resume/suspend the network stack.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="keywordtype">void</span> main_task()</div>
<div class="line">    {</div>
<div class="line">        ...</div>
<div class="line">        <span class="keywordflow">for</span> (;;)</div>
<div class="line">        {</div>
<div class="line">           <a class="code hl_function" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div>
<div class="line">           vTaskDelay(pdMS_TO_TICKS(100));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    </div>
<div class="line">    <span class="keywordtype">void</span> child_task()</div>
<div class="line">    {</div>
<div class="line">        ...</div>
<div class="line">        <span class="comment">/* Call LPA API to resume network stack which is suspended by wait_net_suspend</span></div>
<div class="line"><span class="comment">         * Function. This should be called by any process which wants to send packets to</span></div>
<div class="line"><span class="comment">         * WLAN when network stack is suspended.</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        cylpa_on_emac_activity(<span class="keyword">true</span>);</div>
<div class="line"> </div>
<div class="line">        <span class="comment">/* Call any API to queue packets to LwIP</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        ...</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="ttc" id="agroup__lpautilities_html_ga8fe3dbb6666cb69c052385ce9ff9405f"><div class="ttname"><a href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a></div><div class="ttdeci">int32_t wait_net_suspend(void *net_intf, uint32_t wait_ms, uint32_t network_inactive_interval_ms, uint32_t network_inactive_window_ms)</div><div class="ttdoc">Network Monitor Function.</div><div class="ttdef"><b>Definition:</b> network_activity_handler.c:578</div></div>
</div><!-- fragment --><h2><a class="anchor" id="subsection_lpa_snippet_2"></a>
Code Snippet 2: Read OLM configuration from device configurator.</h2>
<p >The following code snippet demonstrates an example for reading OLM configuration from device configurator and makes a local copy of the list. </p><div class="fragment"><div class="line">        ...</div>
<div class="line">        <a class="code hl_struct" href="structolm__t.html">olm_t</a> *olm_inst = NULL;</div>
<div class="line">        <a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a>* dev_cfg_list = NULL;</div>
<div class="line"> </div>
<div class="line">        olm_inst = cy_get_olm_instance();</div>
<div class="line">        <span class="keywordflow">if</span> ( olm_inst != NULL )</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* make a copy to local list */</span></div>
<div class="line">            dev_cfg_list = (<a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a> *)olm_inst-&gt;<a class="code hl_variable" href="structolm__t.html#a2b190f623aefb6f3c6e51cc62b751789">ol_list</a>;</div>
<div class="line">            ...</div>
<div class="ttc" id="astructol__desc__t_html"><div class="ttname"><a href="structol__desc__t.html">ol_desc_t</a></div><div class="ttdoc">Offload instance description table entry.</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_ol.h:32</div></div>
<div class="ttc" id="astructolm__t_html"><div class="ttname"><a href="structolm__t.html">olm_t</a></div><div class="ttdoc">Offload Manager context.</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_olm.h:57</div></div>
<div class="ttc" id="astructolm__t_html_a2b190f623aefb6f3c6e51cc62b751789"><div class="ttname"><a href="structolm__t.html#a2b190f623aefb6f3c6e51cc62b751789">olm_t::ol_list</a></div><div class="ttdeci">const struct ol_desc * ol_list</div><div class="ttdoc">Offload Assist list.</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_olm.h:58</div></div>
</div><!-- fragment --><h2><a class="anchor" id="subsection_lpa_snippet_3"></a>
Code Snippet 3: Search for TCP KA offload in the device configurator list.</h2>
<p >The following code snippet demonstrates an example for searching the "TKO" string in the device configurator list and if not present it add manual TCP KA offload configuration. </p><div class="fragment"><div class="line">        ...</div>
<div class="line">        tmp = <a class="code hl_function" href="group__lpautilities.html#gabdd78072ac977129c8202559f39f70a4">cylpa_find_my_descriptor</a> ( <span class="stringliteral">&quot;ARP&quot;</span>, dev_cfg_list);</div>
<div class="line">        <span class="keywordflow">if</span> ( tmp != NULL )</div>
<div class="line">        {</div>
<div class="line">            i++;</div>
<div class="line">        }</div>
<div class="line">        tmp = <a class="code hl_function" href="group__lpautilities.html#gabdd78072ac977129c8202559f39f70a4">cylpa_find_my_descriptor</a> (<span class="stringliteral">&quot;PKT_Filter&quot;</span>, dev_cfg_list );</div>
<div class="line">        <span class="keywordflow">if</span> ( tmp != NULL )</div>
<div class="line">        {</div>
<div class="line">            i++;</div>
<div class="line">        }</div>
<div class="line">        tmp = <a class="code hl_function" href="group__lpautilities.html#gabdd78072ac977129c8202559f39f70a4">cylpa_find_my_descriptor</a> ( <span class="stringliteral">&quot;TKO&quot;</span>, dev_cfg_list );</div>
<div class="line">        <span class="keywordflow">if</span> ( tmp == NULL )</div>
<div class="line">        {</div>
<div class="line">           <span class="comment">/* ADD TKO to list */</span></div>
<div class="line">           dev_cfg_list = (<a class="code hl_struct" href="structcy__tko__ol__cfg__t.html">cy_tko_ol_cfg_t</a> *)tmp-&gt;<a class="code hl_variable" href="structol__desc__t.html#ae2465ecd5a2e0acd0dc6977405542194">cfg</a>;</div>
<div class="line">           dev_cfg_list[i].name  = <span class="stringliteral">&quot;TKO&quot;</span>;</div>
<div class="line">           dev_cfg_list[i].cfg   = &amp;tko_new_cfgs[0];</div>
<div class="line">           dev_cfg_list[i].fns   = &amp;tko_ol_fns;</div>
<div class="line">           dev_cfg_list[i].ol    = &amp;tko_ctxt;</div>
<div class="line">        }</div>
<div class="line">        ...</div>
<div class="ttc" id="agroup__lpautilities_html_gabdd78072ac977129c8202559f39f70a4"><div class="ttname"><a href="group__lpautilities.html#gabdd78072ac977129c8202559f39f70a4">cylpa_find_my_descriptor</a></div><div class="ttdeci">ol_desc_t * cylpa_find_my_descriptor(const char *name, ol_desc_t *offload_list)</div><div class="ttdoc">Finds OLM descriptor for a given name.</div><div class="ttdef"><b>Definition:</b> network_activity_handler.c:921</div></div>
<div class="ttc" id="astructcy__tko__ol__cfg__t_html"><div class="ttname"><a href="structcy__tko__ol__cfg__t.html">cy_tko_ol_cfg_t</a></div><div class="ttdoc">User uses configurator to set these.</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_tko_ol.h:35</div></div>
<div class="ttc" id="astructol__desc__t_html_ae2465ecd5a2e0acd0dc6977405542194"><div class="ttname"><a href="structol__desc__t.html#ae2465ecd5a2e0acd0dc6977405542194">ol_desc_t::cfg</a></div><div class="ttdeci">const void * cfg</div><div class="ttdoc">Offload-specific configuration.</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_ol.h:34</div></div>
</div><!-- fragment --><h2><a class="anchor" id="subsection_lpa_snippet_5"></a>
Code Snippet 5: Use cy_tcp_create_socket_connection to offload TCP Keep-alive to WiFi Firmware</h2>
<p >The following code snippet demonstrates an example for creating TCP connection(s) and offloads TCP keep-alive when host MCU enters sleep/deepsleep via wait_net_suspend API call. </p><div class="fragment"><div class="line">        ...</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> index = 0; index &lt; MAX_TKO; index++)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* Establish TCP connection */</span></div>
<div class="line">            response =  <a class="code hl_function" href="group__lpautilities.html#gab1bdee5b863d063b2cfb1dc693f8b685">cy_tcp_create_socket_connection</a>(netwk_intf, (<span class="keywordtype">void</span> **)&amp;glob_socket[index], remote_ip[index],</div>
<div class="line">                                                        remote_port[index], local_port[index], tko_new_cfgs, tcp_keealive_flag);</div>
<div class="line">            ....</div>
<div class="ttc" id="agroup__lpautilities_html_gab1bdee5b863d063b2cfb1dc693f8b685"><div class="ttname"><a href="group__lpautilities.html#gab1bdee5b863d063b2cfb1dc693f8b685">cy_tcp_create_socket_connection</a></div><div class="ttdeci">int cy_tcp_create_socket_connection(void *net_intf, void **global_socket_ptr, const char *remote_ip, uint16_t remote_port, uint16_t local_port, cy_tko_ol_cfg_t *downloaded, int socket_keepalive_enable)</div><div class="ttdoc">Creates TCP Socket connection.</div><div class="ttdef"><b>Definition:</b> network_activity_handler.c:761</div></div>
</div><!-- fragment --><h2><a class="anchor" id="subsection_lpa_snippet_6"></a>
Code Snippet 6: Read OLM configuration from device configurator.</h2>
<p >The following code snippet demonstrates an example for reading OLM configuration from device configurator and makes a local copy of the list. </p><div class="fragment"><div class="line">        ...</div>
<div class="line">        <span class="keywordtype">void</span> *olm_inst = NULL;</div>
<div class="line">        <a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a>* dev_cfg_list = NULL;</div>
<div class="line"> </div>
<div class="line">        olm_inst = cy_get_olm_instance();</div>
<div class="line">        <span class="keywordflow">if</span> ( olm_inst != NULL )</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* make a copy to local list */</span></div>
<div class="line">            dev_cfg_list = (<a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a> *)get_default_ol_list();</div>
<div class="line">            ...</div>
</div><!-- fragment --><h2><a class="anchor" id="subsection_lpa_snippet_7"></a>
Code Snippet 7: MQTT offload configuration.</h2>
<p >The following code snippet demonstrates an example for MQTT offload configuration from application. </p><div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#define MQTT_BROKER                         &quot; &quot;</span> <span class="comment">/* Add the broker end point info here. */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor">#define MQTT_PORT_SECURED                   ( 8883 )</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER              &quot;InfineonTest&quot;</span></div>
<div class="line"><span class="preprocessor">#define MQTT_CLIENT_IDENTIFIER_LENGTH       ( ( uint16_t ) ( sizeof( MQTT_CLIENT_IDENTIFIER ) - 1 ) )</span></div>
<div class="line"><span class="preprocessor">#define MQTT_KEEP_ALIVE_INTERVAL_SECONDS    ( 60U )</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MQTT_QOS2                           ( 2U )</span></div>
<div class="line"><span class="preprocessor">#define MQTT_TOPIC                          &quot;Test_Topic&quot;</span></div>
<div class="line"><span class="preprocessor">#define MQTT_TOPIC_LENGTH                   ( ( uint16_t ) ( sizeof( MQTT_TOPIC ) - 1 ) )</span></div>
<div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE                   &quot;Will message - World!&quot;</span></div>
<div class="line"><span class="preprocessor">#define MQTT_WILL_MESSAGE_LENGTH            ( ( uint16_t ) ( sizeof( MQTT_WILL_MESSAGE ) - 1 ) )</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define MQTT_NUM_OF_SUBS_IN_SINGLE_REQ      ( 1U )</span></div>
<div class="line"><span class="preprocessor">#define MQTT_NUM_OF_UNSUBS_IN_SINGLE_REQ    MQTT_NUM_OF_SUBS_IN_SINGLE_REQ</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define NETWORK_BUFFER_SIZE                 ( 1024U )</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment"> * This macro specifies the interval in milliseconds that the device monitors</span></div>
<div class="line"><span class="comment"> * the network for inactivity. If the network is inactive for a duration shorter</span></div>
<div class="line"><span class="comment"> * than INACTIVE_WINDOW_MS in this interval, the MCU does not suspend the network</span></div>
<div class="line"><span class="comment"> * stack and informs the calling function that the MCU wait period timed out</span></div>
<div class="line"><span class="comment"> * while waiting for network to become inactive.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define INACTIVE_INTERVAL_MS    (300)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* </span></div>
<div class="line"><span class="comment"> * This macro specifies the continuous duration in milliseconds for which the</span></div>
<div class="line"><span class="comment"> * network has to be inactive. If the network is inactive for this duration,</span></div>
<div class="line"><span class="comment"> * the MCU will suspend the network stack. Now, the MCU will not need to service</span></div>
<div class="line"><span class="comment"> * the network timers which allows it to stay longer in sleep/deepsleep.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define INACTIVE_WINDOW_MS      (200)</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> client_certificate[]  = { <span class="stringliteral">&quot;Paste client certificate here&quot;</span> };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> client_private_key[]  = { <span class="stringliteral">&quot;Paste client key here&quot;</span> };</div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> root_ca_certificate[] = { <span class="stringliteral">&quot;Paste RootCA certificate here&quot;</span> };</div>
<div class="line">cy_mqtt_t         mqtt_handle;</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Callback function registered with MQTT library while creating handle for MQTT connection.</span></div>
<div class="line"><span class="comment">   This callback function will be called by MQTT library upon receiving MQTT messages on subscribed topics or when</span></div>
<div class="line"><span class="comment">   network disconnection happens. */</span></div>
<div class="line"><span class="keywordtype">void</span> mqtt_eventcb( cy_mqtt_t mqtt_handle, cy_mqtt_event_t event, <span class="keywordtype">void</span> *user_data )</div>
<div class="line">{</div>
<div class="line">    cy_mqtt_received_msg_info_t *received_msg;</div>
<div class="line">    printf( <span class="stringliteral">&quot;\nMQTT App callback with handle : %p \n&quot;</span>, mqtt_handle );</div>
<div class="line">    (void)user_data;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span>( event.type )</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">case</span> CY_MQTT_EVENT_TYPE_DISCONNECT :</div>
<div class="line">            printf( <span class="stringliteral">&quot;\nEvent : Received MQTT Disconnect event.\n&quot;</span> );</div>
<div class="line">            <span class="keywordflow">switch</span>( event.data.reason )</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">case</span> CY_MQTT_DISCONN_TYPE_BROKER_DOWN :</div>
<div class="line">                    <span class="comment">/* Keep-alive response not received from broker, possibly broker is down. */</span></div>
<div class="line">                    printf( <span class="stringliteral">&quot;Reason : MQTT Ping response not received within keep-alive response timeout... \n\n&quot;</span> );</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CY_MQTT_DISCONN_TYPE_NETWORK_DOWN :</div>
<div class="line">                    <span class="comment">/* Network is disconnected. */</span></div>
<div class="line">                    printf( <span class="stringliteral">&quot;Reason : Network is disconnected... \n\n&quot;</span> );</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CY_MQTT_DISCONN_TYPE_SND_RCV_FAIL :</div>
<div class="line">                    <span class="comment">/* MQTT packet send or receive operation failed due to network latency (or) send/receive related timeouts. */</span></div>
<div class="line">                    printf( <span class="stringliteral">&quot;Reason : MQTT packet send or receive operation failed... \n\n&quot;</span> );</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                <span class="keywordflow">case</span> CY_MQTT_DISCONN_TYPE_BAD_RESPONSE :</div>
<div class="line">                    <span class="comment">/* Bad response from MQTT broker. Possibly received MQTT packet with invalid packet type ID. */</span></div>
<div class="line">                    printf( <span class="stringliteral">&quot;Reason : Bad response from MQTT broker... \n\n&quot;</span> );</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">                default :</div>
<div class="line">                    printf( <span class="stringliteral">&quot;\n Unknown disconnect reason .....\n&quot;</span> );</div>
<div class="line">                    <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> CY_MQTT_EVENT_TYPE_SUBSCRIPTION_MESSAGE_RECEIVE :</div>
<div class="line">            <span class="comment">/* Received MQTT messages on subscribed topic. */</span></div>
<div class="line">            printf( <span class="stringliteral">&quot;\nEvent : Received MQTT subscribed message receive event.\n&quot;</span> );</div>
<div class="line">            received_msg = &amp;(<span class="keyword">event</span>.data.pub_msg.received_message);</div>
<div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Topic Name: %.*s\n&quot;</span>, received_msg-&gt;topic_len, received_msg-&gt;topic );</div>
<div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish message Packet Id is %u.\n&quot;</span>, event.data.pub_msg.packet_id );</div>
<div class="line">            printf( <span class="stringliteral">&quot;Incoming Publish Message : %.*s.\n\n&quot;</span>, ( <span class="keywordtype">int</span> )received_msg-&gt;payload_len, ( <span class="keyword">const</span> <span class="keywordtype">char</span> * )received_msg-&gt;payload );</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        default :</div>
<div class="line">            printf( <span class="stringliteral">&quot;\nUNKNOWN EVENT .....\n&quot;</span> );</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">const</span> <a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a>* find_my_tlsoe_descriptor(<span class="keyword">const</span> <span class="keywordtype">char</span>* name)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a>* offloads_list;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Take offload configuration defined by the configurator */</span></div>
<div class="line">    offloads_list = (<span class="keyword">const</span> <a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a>*)get_default_ol_list();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Return the TCP keepalive offload configuration if it exists. */</span></div>
<div class="line">    <span class="keywordflow">while</span> (offloads_list &amp;&amp; offloads_list-&gt;<a class="code hl_variable" href="structol__desc__t.html#aa710e639017abd5fa8b0bf08f255935f">name</a> &amp;&amp;</div>
<div class="line">        (0 != strncmp(offloads_list-&gt;<a class="code hl_variable" href="structol__desc__t.html#aa710e639017abd5fa8b0bf08f255935f">name</a>, name, strlen(name))))</div>
<div class="line">    {</div>
<div class="line">        offloads_list++;</div>
<div class="line">        printf(<span class="stringliteral">&quot;offloads_list.name:[%s]\n&quot;</span>,offloads_list-&gt;<a class="code hl_variable" href="structol__desc__t.html#aa710e639017abd5fa8b0bf08f255935f">name</a>);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">if</span> (!offloads_list || !offloads_list-&gt;<a class="code hl_variable" href="structol__desc__t.html#aa710e639017abd5fa8b0bf08f255935f">name</a>)</div>
<div class="line">    {</div>
<div class="line">        printf(<span class="stringliteral">&quot;Unable to find %s offloads configuration\n&quot;</span>, name);</div>
<div class="line">        offloads_list = NULL;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">return</span> offloads_list;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> snippet7( <span class="keywordtype">void</span> )</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Status variables for various operations. */</span></div>
<div class="line">    cy_rslt_t                     TestRes = CY_RSLT_SUCCESS;</div>
<div class="line">    cy_mqtt_publish_info_t        will_msg;</div>
<div class="line">    cy_mqtt_connect_info_t        connect_info;</div>
<div class="line">    cy_mqtt_broker_info_t         broker_info;</div>
<div class="line">    cy_awsport_ssl_credentials_t  credentials;</div>
<div class="line">    cy_awsport_ssl_credentials_t  *security = NULL;</div>
<div class="line">    uint8_t                       *buffer = NULL;</div>
<div class="line">    cy_mqtt_subscribe_info_t      sub_msg[1];</div>
<div class="line">    cy_mqtt_unsubscribe_info_t    unsub_msg[1];</div>
<div class="line"> </div>
<div class="line">    cy_socket_sockaddr_t local_address;</div>
<div class="line">    cy_socket_sockaddr_t peer_address;</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_struct" href="structol__desc__t.html">ol_desc_t</a>* offload_list;</div>
<div class="line">    <span class="keyword">const</span> <a class="code hl_struct" href="structcy__tlsoe__ol__cfg__t.html">cy_tlsoe_ol_cfg_t</a>* downloaded;</div>
<div class="line">    cy_socket_t sock_handle;</div>
<div class="line">    <span class="keyword">struct </span>netif *wifi;</div>
<div class="line">    uint32_t sockopt_len;</div>
<div class="line">    </div>
<div class="line">    (void)TestRes;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initialize the MQTT network socket. */</span></div>
<div class="line">    TestRes = cy_mqtt_init();</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/*Allocate the network buffer. */</span></div>
<div class="line">    buffer = (uint8_t *) malloc( <span class="keyword">sizeof</span>(uint8_t) * NETWORK_BUFFER_SIZE );</div>
<div class="line">    <span class="keywordflow">if</span>( buffer == NULL )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    memset( &amp;will_msg, 0x00, <span class="keyword">sizeof</span>( cy_mqtt_publish_info_t ) );</div>
<div class="line">    memset( &amp;broker_info, 0x00, <span class="keyword">sizeof</span>( cy_mqtt_broker_info_t ) );</div>
<div class="line">    memset( &amp;connect_info, 0x00, <span class="keyword">sizeof</span>( cy_mqtt_connect_info_t ) );</div>
<div class="line">    memset( &amp;credentials, 0x00, <span class="keyword">sizeof</span>( cy_awsport_ssl_credentials_t ) );</div>
<div class="line">    memset( &amp;sub_msg, 0x00, <span class="keyword">sizeof</span>( cy_mqtt_subscribe_info_t ) );</div>
<div class="line">    memset( &amp;unsub_msg, 0x00, <span class="keyword">sizeof</span>( cy_mqtt_unsubscribe_info_t ) );</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set the will information. */</span></div>
<div class="line">    will_msg.qos = (cy_mqtt_qos_t)MQTT_QOS2;</div>
<div class="line">    will_msg.topic = MQTT_TOPIC;</div>
<div class="line">    will_msg.topic_len = MQTT_TOPIC_LENGTH;</div>
<div class="line">    will_msg.payload = MQTT_WILL_MESSAGE;</div>
<div class="line">    will_msg.payload_len = MQTT_WILL_MESSAGE_LENGTH;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set the credential information. */</span></div>
<div class="line">    credentials.client_cert = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;client_certificate;</div>
<div class="line">    credentials.client_cert_size = <span class="keyword">sizeof</span>( client_certificate );</div>
<div class="line">    credentials.private_key = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;client_private_key;</div>
<div class="line">    credentials.private_key_size = <span class="keyword">sizeof</span>( client_private_key );</div>
<div class="line">    credentials.root_ca = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) &amp;root_ca_certificate;</div>
<div class="line">    credentials.root_ca_size = <span class="keyword">sizeof</span>( root_ca_certificate );</div>
<div class="line"> </div>
<div class="line">    security = &amp;credentials;</div>
<div class="line"> </div>
<div class="line">    connect_info.client_id = MQTT_CLIENT_IDENTIFIER;</div>
<div class="line">    connect_info.client_id_len = MQTT_CLIENT_IDENTIFIER_LENGTH;</div>
<div class="line">    connect_info.keep_alive_sec = MQTT_KEEP_ALIVE_INTERVAL_SECONDS;</div>
<div class="line">    connect_info.will_info = &amp;will_msg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* MQTT broker information. */</span></div>
<div class="line">    broker_info.hostname = MQTT_BROKER;</div>
<div class="line">    broker_info.hostname_len = strlen(MQTT_BROKER);</div>
<div class="line">    broker_info.port = MQTT_PORT_SECURED;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Create MQTT Handle. */</span></div>
<div class="line">    TestRes = cy_mqtt_create( buffer, NETWORK_BUFFER_SIZE,</div>
<div class="line">                              security, &amp;broker_info,</div>
<div class="line">                              <span class="stringliteral">&quot;broker4&quot;</span>,</div>
<div class="line">                              &amp;mqtt_handle );</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Register callback for MQTT events. */</span></div>
<div class="line">    TestRes = cy_mqtt_register_event_callback(mqtt_handle, (cy_mqtt_callback_t)mqtt_eventcb, NULL);</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    TestRes = cy_mqtt_connect( mqtt_handle, &amp;connect_info );</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Subscribe request. */</span></div>
<div class="line">    sub_msg[0].qos = (cy_mqtt_qos_t)MQTT_QOS2;</div>
<div class="line">    sub_msg[0].topic = MQTT_TOPIC;</div>
<div class="line">    sub_msg[0].topic_len = MQTT_TOPIC_LENGTH;</div>
<div class="line"> </div>
<div class="line">    TestRes = cy_mqtt_subscribe( mqtt_handle, &amp;sub_msg[0], MQTT_NUM_OF_SUBS_IN_SINGLE_REQ );</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Get the socket handle associated with the MQTT handle */</span> </div>
<div class="line">    TestRes = cy_mqtt_get_socket(mqtt_handle, &amp;sock_handle);</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line">   </div>
<div class="line">    <span class="comment">/* Get the MQTT offload persionality configurations from Device Configurator */</span></div>
<div class="line">    offload_list = find_my_tlsoe_descriptor(TLS_KEEPALIVE_OFFLOAD);</div>
<div class="line">   </div>
<div class="line">    downloaded = (<span class="keyword">const</span> <a class="code hl_struct" href="structcy__tlsoe__ol__cfg__t.html">cy_tlsoe_ol_cfg_t</a>*)offload_list-&gt;<a class="code hl_variable" href="structol__desc__t.html#ae2465ecd5a2e0acd0dc6977405542194">cfg</a>; </div>
<div class="line">    </div>
<div class="line">    <span class="comment">/* Update the personality configurations to the LPA middleware */</span>   </div>
<div class="line">    TestRes = <a class="code hl_function" href="group__lpautilities.html#gac8baee212cc2fb0a8fba206c78c80846">cylpa_tlsoe_ol_update_config</a>(0, downloaded, sock_handle);</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    sockopt_len = <span class="keyword">sizeof</span>(cy_socket_sockaddr_t);</div>
<div class="line">    <span class="comment">/* Get the local port and IP address associated with the socket */</span>  </div>
<div class="line">    TestRes = cy_socket_getsockopt(sock_handle, CY_SOCKET_SOL_SOCKET, CY_SOCKET_SO_LOCALADDR, &amp;local_address, &amp;sockopt_len);</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    sockopt_len = <span class="keyword">sizeof</span>(cy_socket_sockaddr_t);</div>
<div class="line">    <span class="comment">/* Get the remote port and IP address associated with the socket */</span> </div>
<div class="line">    TestRes = cy_socket_getsockopt(sock_handle, CY_SOCKET_SOL_SOCKET, CY_SOCKET_SO_PEERADDR, &amp;peer_address, &amp;sockopt_len);</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Set the local port/IP address and remote port/IP address to LPA middleware */</span>    </div>
<div class="line">    TestRes = <a class="code hl_function" href="group__lpautilities.html#ga44cedc2605f0e57f5271c10de0293c2c">cylpa_tlsoe_ol_set_socket_config</a>(index, local_address.port , peer_address.port , &amp;peer_address.ip_address.ip.v4, connect_info.keep_alive_sec);</div>
<div class="line">    <span class="keywordflow">if</span>( TestRes != CY_RSLT_SUCCESS )</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Failure path. */</span></div>
<div class="line">        <span class="keywordflow">return</span>;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Obtain the reference to the lwIP network interface. This reference is used to</span></div>
<div class="line"><span class="comment">     * access the Wi-Fi driver interface to configure the WLAN power save modes.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    wifi = cy_network_get_nw_interface(CY_NETWORK_WIFI_STA_INTERFACE, 0);</div>
<div class="line">    </div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* This API will suspend the network stack and put host to sleep and enable MQTT keepalive offload.</span></div>
<div class="line"><span class="comment">         * This API will return when a message on subscribed topic is received with matching MQTT wake pattern</span></div>
<div class="line"><span class="comment">         */</span></div>
<div class="line">        <a class="code hl_function" href="group__lpautilities.html#ga8fe3dbb6666cb69c052385ce9ff9405f">wait_net_suspend</a>(wifi, portMAX_DELAY, INACTIVE_INTERVAL_MS, INACTIVE_WINDOW_MS);</div>
<div class="line">        vTaskDelay(pdMS_TO_TICKS(100));</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="ttc" id="agroup__lpautilities_html_ga44cedc2605f0e57f5271c10de0293c2c"><div class="ttname"><a href="group__lpautilities.html#ga44cedc2605f0e57f5271c10de0293c2c">cylpa_tlsoe_ol_set_socket_config</a></div><div class="ttdeci">int cylpa_tlsoe_ol_set_socket_config(int index, uint16_t local_port, uint16_t remote_port, uint32_t *remote_ip, uint16_t interval)</div><div class="ttdoc">configure the TLS connection parameters like local and peer port, peer IP and keepalive interval.</div></div>
<div class="ttc" id="agroup__lpautilities_html_gac8baee212cc2fb0a8fba206c78c80846"><div class="ttname"><a href="group__lpautilities.html#gac8baee212cc2fb0a8fba206c78c80846">cylpa_tlsoe_ol_update_config</a></div><div class="ttdeci">int cylpa_tlsoe_ol_update_config(int index, cy_tlsoe_ol_cfg_t *cfg, void *socket)</div><div class="ttdoc">Update TLS configuration parameters and socket handle to LPA TLS database.</div></div>
<div class="ttc" id="astructcy__tlsoe__ol__cfg__t_html"><div class="ttname"><a href="structcy__tlsoe__ol__cfg__t.html">cy_tlsoe_ol_cfg_t</a></div><div class="ttdoc">User configurations set in device configurator.</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_tls_ol.h:49</div></div>
<div class="ttc" id="astructol__desc__t_html_aa710e639017abd5fa8b0bf08f255935f"><div class="ttname"><a href="structol__desc__t.html#aa710e639017abd5fa8b0bf08f255935f">ol_desc_t::name</a></div><div class="ttdeci">const char * name</div><div class="ttdoc">Friendly name for debug (XXX: make debug only).</div><div class="ttdef"><b>Definition:</b> cy_lpa_wifi_ol.h:33</div></div>
</div><!-- fragment --><h1><a class="anchor" id="apis"></a>
LPA API</h1>
<p >LPA API's used by LPA middleware. LPA API's are documented below.  
 <ul>
 <li><a href="group__lpautilities.html">LPA API</a></li>
 </ul>
 <br>
  </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>Low Power Assistant Middleware Library 5.8.0</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
</body>
</html>
